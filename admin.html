<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaceAnalyst | Professional Indian Horse Racing Selections</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Source+Serif+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Serif Pro', serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }
        
        h1, h2, h3, h4, h5 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: #1a3c34;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background-color: #1a3c34;
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 2rem;
            color: #d4af37;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            color: white;
            font-weight: 700;
        }
        
        .logo span {
            color: #d4af37;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
            align-items: center;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        nav a:hover {
            color: #d4af37;
        }
        
        .admin-menu-item {
            background: none;
            padding: 0;
            border-radius: 0;
            color: #d4af37 !important;   /* subtle highlight */
            font-weight: 600;
        }
        
        .admin-menu-item:hover {
            color: #ffffff !important;
        }
        
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(26, 60, 52, 0.85), rgba(26, 60, 52, 0.9)), url('https://images.unsplash.com/photo-1551128898-fbc65aaf6d6e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 2.5rem 0;
            text-align: center;
        }
        
        .hero h2 {
            font-size: 1.8rem;   /* match RaceAnalyst visual weight */
            margin-bottom: 0.8rem;
            color: white;
        }
        
        .hero p {
            font-size: 1.05rem;      /* slightly reduced */
            white-space: nowrap;    /* FORCE single line */
            max-width: 100%;
            margin: 0 auto 1.4rem;  /* controls spacing below */
        }
        
        .cta-button {
            display: inline-block;
            background-color: #d4af37;
            color: #1a3c34;
            padding: 0.8rem 2rem;
            border-radius: 4px;
            text-decoration: none;
            margin-top: 0.6rem;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        
        .cta-button:hover {
            background-color: #e6c244;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .cta-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .cta-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2.5rem;
            padding: 3rem 0;
            align-items: start; /* üî¥ CRITICAL CHANGE */
        }
        
        /* Selection Section */
        .selection-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            padding: 1.2rem 1.5rem;
            margin-bottom: 2rem;
        }
        
        .selection-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.7rem;
            border-bottom: 2px solid #d4af37;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .selection-title i {
            color: #d4af37;
        }
        
        /* Updated Dropdown Grid for Horizontal Alignment */
        .dropdown-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .dropdown-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0; /* Allow flexbox to shrink */
        }
        
        /* Specific widths for each dropdown */
        .venue-dropdown {
            flex: 1;
            min-width: 180px; /* Enough for "Bangalore" */
            max-width: 200px;
        }
        
        .date-dropdown {
            flex: 0 0 190px; /* wider so full date incl. year is visible */
        }

        .race-dropdown {
            flex: 0 0 130px;
            margin-left: 10px; /* visual breathing space from date */
        }
        
        .dropdown-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        
        select {
            padding: 8px 12px;              /* slimmer height */
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;             /* slightly smaller text */
            background: white;
            color: #1a3c34;                 /* stronger, cleaner text */
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: 'Source Serif Pro', serif;
            width: 100%;
        }
        
        select option {
            padding: 6px;
            font-size: 0.95rem;
        }

        select:hover {
            border-color: #d4af37;
        }

        select:focus {
            outline: none;
            border-color: #1a3c34;
            box-shadow: 0 0 0 2px rgba(26, 60, 52, 0.12);
        }

        select:focus {
            outline: none;
            border-color: #1a3c34;
            box-shadow: 0 0 0 3px rgba(26, 60, 52, 0.1);
        }
        
        /* Analysis Display - Stretch to sidebar bottom using grid/flex */
        .analysis-display {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .left-column {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .analysis-header {
            background-color: #1a3c34;
            color: white;
            padding: 1.5rem;
            flex-shrink: 0;
        }
        
        .analysis-header h3 {
            color: white;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        
        .race-info {
            display: flex;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: #d4af37;
            flex-wrap: wrap;
        }
        
        .analysis-content {
            padding: 2rem;
            overflow-y: auto; /* Enable vertical scrollbar */
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.8;
            background: #f8f9fa;
            flex-grow: 1;
        }
        
        .no-analysis {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .no-analysis i {
            font-size: 3rem;
            color: #e9ecef;
            margin-bottom: 1rem;
        }
        
        /* Sidebar Widgets */
        .sidebar-widget {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .sidebar-widget h3 {
            border-bottom: 2px solid #d4af37;
            padding-bottom: 0.7rem;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upcoming-races li {
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .upcoming-races li:last-child {
            border-bottom: none;
        }
        
        .race-venue {
            font-weight: 600;
            color: #1a3c34;
        }
        
        .race-date {
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            text-align: center;
        }
        
        .stat-item {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #d4af37;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Calendar Widget */
        .calendar-container {
            margin-top: 1rem;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day {
            padding: 0.5rem;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .calendar-day:hover {
            background-color: rgba(212, 175, 55, 0.1);
        }
        
        .calendar-day.race-day {
            background-color: rgba(212, 175, 55, 0.2);
            font-weight: 600;
        }
        
        .calendar-day.today {
            background-color: #d4af37;
            color: #1a3c34;
            font-weight: 600;
        }
        
        .calendar-day-header {
            font-weight: 600;
            color: #d4af37;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        /* Newsletter Form */
        .newsletter-form {
            margin-top: 1rem;
        }
        
        .newsletter-form input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background-color: white;
            color: #495057;
        }
        
        .newsletter-form button {
            width: 100%;
            padding: 0.8rem;
            background-color: #1a3c34;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .newsletter-form button:hover {
            background-color: #2d5248;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: #fff8e1;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            display: none;
            grid-column: 1 / -1;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .admin-title {
            font-size: 1.3rem;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .admin-form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
            gap: 8px;
        }
        
        .admin-form-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        input[type="text"], input[type="date"] {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Source Serif Pro', serif;
            width: 100%;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 200px;
            margin-bottom: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .btn-primary {
            background: #1a3c34;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2d5248;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 60, 52, 0.2);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #1a3c34;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Admin label styling */
        .admin-label span {
            color: #ffc107;
            font-weight: 600;
            cursor: default;
        }

        /* Footer */
        footer {
            background-color: #1a3c34;
            color: white;
            padding: 3rem 0 1.5rem;
            margin-top: 3rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .footer-section h4 {
            color: #d4af37;
            margin-bottom: 1.2rem;
            font-size: 1.2rem;
        }
        
        .footer-section p {
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-links a {
            color: white;
            background-color: #2d5248;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .social-links a:hover {
            background-color: #d4af37;
            transform: translateY(-3px);
        }
        
        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid #2d5248;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .footer-content {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Removed .analysis-display { min-height: auto; } */
            .admin-form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: row; /* Keep row layout for header */
                gap: 1rem;
                position: relative;
            }
            
            .mobile-menu-btn {
                display: block !important;
                z-index: 1001;
            }
            
            .nav-menu ul {
                position: fixed;
                top: 0;
                right: -100%;
                flex-direction: column;
                align-items: center;
                gap: 0;
                width: 280px;
                height: 100vh;
                background: #1a3c34;
                padding: 100px 20px 40px;
                transition: right 0.3s ease-in-out;
                z-index: 1000;
                box-shadow: -5px 0 15px rgba(0,0,0,0.1);
                margin: 0;
                list-style: none;
                overflow-y: auto;
            }
            
            .nav-menu.active ul {
                right: 0;
            }
            
            .nav-menu ul li {
                width: 100%;
                text-align: center;
                padding: 0;
                margin: 0;
            }
            
            .nav-menu ul li a {
                display: block;
                padding: 15px 20px;
                font-size: 1.1rem;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                width: 100%;
                box-sizing: border-box;
            }
            
            .nav-menu ul li a:hover {
                background: rgba(255,255,255,0.1);
            }
            
            /* Overlay for when menu is open */
            .nav-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            
            .nav-overlay.active {
                display: block;
            }
            
            .hero h2 {
                font-size: 2rem;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
            }
            
            .dropdown-grid {
                flex-direction: column;
                align-items: stretch;
            }
            
            .venue-dropdown, .date-dropdown, .race-dropdown {
                min-width: 100%;
                max-width: 100%;
                flex: 1;
            }
            .race-dropdown {
                margin-left: 0;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .admin-form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .race-info {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Prevent body scrolling when menu is open */
        body.menu-open {
            overflow: hidden;
        }

        /* Ensure header has proper z-index */
        header {
            position: relative;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- Professional Header with Admin in Menu -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-horse-head logo-icon"></i>
                <h1>Race<span>Analyst</span></h1>
            </div>
            
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            
            <nav class="nav-menu" id="navMenu">
                <ul>
                    <li class="admin-label">
                        <a href="#" id="adminLoginBtn" style="color: #d4af37; font-weight: 600;">
                            <i class="fas fa-user-shield"></i> Login as Admin
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navigateToHome(); return false;">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navigateToRaceCalendar(); return false;" id="navRaceCalendar">
                            <i class="fas fa-calendar-alt"></i> Race Calendar
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navigateToUpcomingRaces(); return false;" id="navUpcomingRaces">
                            <i class="fas fa-trophy"></i> Upcoming Races
                        </a>
                    </li>
                    <li>
                        <a href="https://raceanalyst.pages.dev/chatcenter" target="_blank" id="navChatCenter">
                            <i class="fas fa-comments"></i> Chat Center
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="navigateToAnalysis(); return false;" id="navAnalysis">
                            <i class="fas fa-clipboard-list"></i> Analysis
                        </a>
                    </li>
                    <li id="logoutItem" style="display: none;">
                        <a href="#" id="logoutBtn" style="color: #ff6b6b;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- Add this line - Overlay for mobile menu -->
            <div class="nav-overlay" id="navOverlay"></div>
        </div>
    </header>

    <!-- Hero Section with Today's Selections Button -->
    <section class="hero">
        <div class="container">
            <h2>Professional Indian Horse Racing Analysis</h2>
            <p>Data-driven selections, performance analytics, and expert insights for Indian Horse Races.</p>
            <a href="#" class="cta-button" id="todaysSelectionsBtn">
                <i class="fas fa-calendar-day"></i> View Today's Selections
            </a>
        </div>
    </section>

    <!-- Main Content with Sidebar -->
    <div class="container main-content">
        <!-- Left Column: Selection Interface -->
        <div class="left-column">
            <!-- Race Selection Card -->
            <div class="selection-card">
                <h2 class="selection-title">
                    <i class="fas fa-search"></i> Select Race for Analysis
                </h2>
                
                <!-- Horizontally aligned dropdowns -->
                <div class="dropdown-grid">
                    <div class="dropdown-group venue-dropdown">
                        <label for="venueSelect"><i class="fas fa-map-marker-alt"></i> Venue</label>
                        <select id="venueSelect">
                            <option value="">Select Venue</option>
                        </select>
                    </div>
                    
                    <div class="dropdown-group date-dropdown">
                        <label for="dateSelect"><i class="far fa-calendar-alt"></i> Date</label>
                        <select id="dateSelect">
                            <option value="">Select Date</option>
                        </select>
                    </div>
                    
                    <div class="dropdown-group race-dropdown">
                        <label for="raceSelect"><i class="fas fa-flag-checkered"></i> Race No.</label>
                        <select id="raceSelect">
                            <option value="">Select Race</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Extended Analysis Display -->
            <div class="analysis-display" id="analysisDisplay">
                <div class="analysis-header">
                    <h3 id="analysisTitle">Race Analysis</h3>
                    <div class="race-info" id="raceInfo" style="display: none;">
                        <span id="selectedVenue"></span>
                        <span id="selectedDate"></span>
                        <span id="selectedRace"></span>
                    </div>
                </div>
                
                <div class="analysis-content" id="analysisContent">
                    <div class="no-analysis">
                        <i class="fas fa-racing-helmet"></i>
                        <p>Select a race from the dropdowns above to view detailed analysis</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Sidebar Widgets -->
        <div class="sidebar">
            <!-- Upcoming Major Races -->
            <div class="sidebar-widget">
                <h3><i class="fas fa-trophy"></i> Upcoming Major Races</h3>
                <ul class="upcoming-races" id="upcomingRaces">
                    <li>Loading upcoming races...</li>
                </ul>
            </div>
            
            
            <!-- Race Calendar -->
            <div class="sidebar-widget">
                <h3><i class="fas fa-calendar-alt"></i> Race Calendar</h3>
                <div class="calendar-container" id="calendarWidget">
                    <!-- Calendar will be generated by JS -->
                </div>
            </div>
            
        </div>
        
        <!-- Admin Panel (Hidden by Default, Full Width) -->
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <h3 class="admin-title">
                    <i class="fas fa-lock"></i> Admin Panel
                </h3>
                <button class="btn-secondary" id="hideAdminBtn">
                    <i class="fas fa-times"></i> Hide Panel
                </button>
            </div>
            
            <div class="admin-form-grid">
                <div class="admin-form-group">
                    <label for="adminVenue"><i class="fas fa-map-marker-alt"></i> Venue</label>
                    <input type="text" id="adminVenue" placeholder="e.g., Mumbai">
                </div>
                
                <div class="admin-form-group">
                    <label for="adminDate"><i class="far fa-calendar-alt"></i> Date</label>
                    <input type="date" id="adminDate">
                </div>
                
                <div class="admin-form-group">
                    <label for="adminRaceNo"><i class="fas fa-flag-checkered"></i> Race Number</label>
                    <input type="text" id="adminRaceNo" placeholder="e.g., 10">
                </div>
            </div>
            
            <div class="admin-form-group">
                <label for="adminAnalysis"><i class="fas fa-edit"></i> Analysis Text</label>
                <textarea id="adminAnalysis" placeholder="Paste your detailed analysis here..."></textarea>
            </div>
            
            <div class="button-group">
                <button class="btn-success" id="saveBtn">
                    <i class="fas fa-save"></i> Save Analysis
                </button>
                <button class="btn-primary" id="updateBtn">
                    <i class="fas fa-edit"></i> Update Selected
                </button>
                <button class="btn-danger" id="deleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn-warning" id="clearBtn">
                    <i class="fas fa-broom"></i> Clear Form
                </button>
            </div>
        </div>
    </div>

    <!-- Professional Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>About RaceAnalyst</h4>
                    <p>Professional analysis and selections for Indian horse racing. Data-driven insights combined with decades of turf experience.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul style="list-style: none;">
                        <li><a href="#" style="color: #ccc; text-decoration: none;">Today's Selections</a></li>
                        <li><a href="#" style="color: #ccc; text-decoration: none;">Performance Tracker</a></li>
                        <li><a href="#" style="color: #ccc; text-decoration: none;">Race Calendar</a></li>
                        <li><a href="#" style="color: #ccc; text-decoration: none;">Subscription Plans</a></li>
                        <li><a href="#" style="color: #ccc; text-decoration: none;">Contact</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p><i class="fas fa-envelope"></i> selections@raceanalyst.in</p>
                    <p><i class="fas fa-phone"></i> +91 98765 43210</p>
                    <p><i class="fas fa-map-marker-alt"></i> Mumbai, India</p>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2024 RaceAnalyst. Professional racing insights. Bet responsibly.</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem;">For entertainment purposes only.</p>
            </div>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>

    /* ---------------------------------------------------
    NAVIGATION FUNCTIONS
    --------------------------------------------------- */
    function navigateToHome() {
        window.location.href = 'index.html#home';
        return false;
    }

    function navigateToRaceCalendar() {
        window.location.href = 'index.html#race-calendar';
        return false;
    }

    function navigateToAnalysis() {
        window.location.href = 'index.html#analysis';
        return false;
    }

    function navigateToUpcomingRaces() {
        window.location.href = 'index.html#upcoming-races';
        return false;
    }
    /* ---------------------------------------------------
    CONFIGURATION
    --------------------------------------------------- */
let raceAnalyses = {};
const workerBase = "https://broad-sound-fdb7.raceanalyst.workers.dev";
    const today = new Date().toISOString().split('T')[0];

    /* ---------------------------------------------------
    DOM ELEMENTS
    --------------------------------------------------- */
    const adminPanel = document.getElementById("adminPanel");
    const hideAdminBtn = document.getElementById("hideAdminBtn");
    const adminVenue = document.getElementById("adminVenue");
    const adminDate = document.getElementById("adminDate");
    const adminRaceNo = document.getElementById("adminRaceNo");
    const adminAnalysis = document.getElementById("adminAnalysis");
    const saveBtn = document.getElementById("saveBtn");
    const updateBtn = document.getElementById("updateBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const clearBtn = document.getElementById("clearBtn");
    const toast = document.getElementById("toast");

    const venueSelect = document.getElementById("venueSelect");
    const dateSelect = document.getElementById("dateSelect");
    const raceSelect = document.getElementById("raceSelect");
    const analysisTitle = document.getElementById("analysisTitle");
    const analysisContent = document.getElementById("analysisContent");
    const raceInfo = document.getElementById("raceInfo");
    const selectedVenue = document.getElementById("selectedVenue");
    const selectedDate = document.getElementById("selectedDate");
    const selectedRace = document.getElementById("selectedRace");
    const calendarWidget = document.getElementById("calendarWidget");

    // Set today's date
    adminDate.value = today;

    /* ---------------------------------------------------
    HELPER FUNCTIONS
    --------------------------------------------------- */
    function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.style.background = type === 'success' ? '#28a745' : 
                            type === 'error' ? '#dc3545' : 
                            type === 'info' ? '#17a2b8' : '#28a745';
        toast.style.display = "block";
        setTimeout(() => (toast.style.display = "none"), 3000);
    }

    function generateKey(venue, date, raceNo) {
        return `${venue}-${date}-${raceNo}`;
    }

    /* ---------------------------------------------------
    CLOUDFLARE KV FUNCTIONS (ONLY STORAGE)
    --------------------------------------------------- */
    async function loadFromKV() {
        try {
            console.log("üì° Loading from Cloudflare KV...");
            
            // Always try to load data, regardless of auth status
            const fetchUrl = workerBase + "/get-all";
            console.log("Fetching URL:", fetchUrl);
            
            const response = await fetch(fetchUrl, {
                method: 'GET',
                headers: { 
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                cache: 'no-store'
            });
            
            console.log("Response status:", response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: Failed to load data`);
            }
            
            const data = await response.json();
            console.log("‚úÖ KV data loaded:", Object.keys(data).length, "items");
            
            if (data && typeof data === 'object') {
                raceAnalyses = data;
                const count = Object.keys(data).length;
                console.log(`‚úÖ Loaded ${count} analyses from Cloudflare KV`);
                showToast(`Loaded ${count} race analyses`, 'success');
                return { success: true, count };
            } else {
                raceAnalyses = {};
                console.log("‚úÖ KV returned empty, starting fresh");
                showToast('No race analyses found', 'info');
                return { success: true, count: 0 };
            }
        } catch (error) {
            console.error("‚ùå KV load error:", error);
            
            // Create some sample data for testing
            raceAnalyses = {
                "Mumbai-2024-01-15-1": {
                    venue: "Mumbai",
                    date: "2024-01-15",
                    raceNo: "1",
                    analysis: "**Race 1 Analysis**\n\n1. Horse A - Strong favorite\n2. Horse B - Good value\n3. Horse C - Long shot"
                },
                "Bangalore-2024-01-14-5": {
                    venue: "Bangalore",
                    date: "2024-01-14",
                    raceNo: "5",
                    analysis: "**Race 5 Analysis**\n\nTop picks:\n1. Speedster\n2. Lightning Bolt\n3. Thunder"
                }
            };
            
            console.log("üìã Using sample data for demonstration");
            showToast('Using sample data (connect to cloud for real data)', 'warning');
            return { success: true, count: Object.keys(raceAnalyses).length };
        }
    }

    // Fallback function
    async function loadFromKVWithFallback() {
        try {
            // Try admin endpoint
            const response = await fetch(workerBase + "/get-all", {
                method: 'GET',
                headers: { 
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                cache: 'no-store'
            });
            
            if (response.ok) {
                const data = await response.json();
                raceAnalyses = data;
                console.log("‚úÖ Loaded from admin endpoint:", Object.keys(data).length, "items");
                return { success: true, count: Object.keys(data).length };
            }
            
            // If admin endpoint requires auth, return empty
            raceAnalyses = {};
            return { success: true, count: 0 };
            
        } catch (error) {
            raceAnalyses = {};
            return { success: true, count: 0 };
        }
    }

    async function saveToKV(key, data) {
        try {
            console.log("üíæ Saving to KV:", key);
            const response = await fetch(workerBase + "/save", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({ key, data })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            console.log("‚úÖ Save successful:", result);
            return { success: true, result };
        } catch (error) {
            console.error("‚ùå Save error:", error);
            throw error; // Re-throw to be handled by caller
        }
    }

    async function deleteFromKV(key) {
        try {
            console.log("üóëÔ∏è Deleting from KV:", key);
            const response = await fetch(workerBase + "/delete", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({ key })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            console.log("‚úÖ Delete successful:", result);
            return { success: true, result };
        } catch (error) {
            console.error("‚ùå Delete error:", error);
            throw error; // Re-throw to be handled by caller
        }
    }

    /* ---------------------------------------------------
    UI MANAGEMENT FUNCTIONS
    --------------------------------------------------- */
    function initializeDropdowns() {
        // Extract unique venues
        const venues = [...new Set(Object.values(raceAnalyses).map(a => a.venue))];
        venueSelect.innerHTML = '<option value="">Select Venue</option>' + 
            venues.map(v => `<option value="${v}">${v}</option>`).join('');
        
        updateDateDropdown();
        updateRaceDropdown();
    }

    function updateDateDropdown() {
        const selectedVenueVal = venueSelect.value;
        let dates = [];
        
        if (selectedVenueVal) {
            dates = [...new Set(Object.values(raceAnalyses)
                .filter(a => a.venue === selectedVenueVal)
                .map(a => a.date)
                .sort((a, b) => b.localeCompare(a)))];
        }
        
        dateSelect.innerHTML = '<option value="">Select Date</option>' + 
            dates.map(d => {
                const dateObj = new Date(d);
                const formatted = dateObj.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                const isToday = d === today ? ' (Today)' : '';
                return `<option value="${d}">${formatted}${isToday}</option>`;
            }).join('');
        
        if (dates.length > 0 && !dateSelect.value) {
            dateSelect.value = dates[0];
            updateRaceDropdown();
        }
        
        updateRaceDropdown();
    }

    function updateRaceDropdown() {
        const selectedVenueVal = venueSelect.value;
        const selectedDateVal = dateSelect.value;
        let races = [];
        
        if (selectedVenueVal && selectedDateVal) {
            races = Object.values(raceAnalyses)
                .filter(a => a.venue === selectedVenueVal && a.date === selectedDateVal)
                .map(a => ({ number: a.raceNo, key: generateKey(a.venue, a.date, a.raceNo) }))
                .sort((a, b) => parseInt(a.number) - parseInt(b.number));
        }
        
        raceSelect.innerHTML = '<option value="">Select Race</option>' + 
            races.map(r => `<option value="${r.key}">Race ${r.number}</option>`).join('');
        
        if (races.length > 0 && !raceSelect.value) {
            raceSelect.value = races[0].key;
            displayAnalysis(races[0].key);
        }
    }

    function displayAnalysis(key) {
        if (!key || !raceAnalyses[key]) {
            analysisContent.innerHTML = '<div class="no-analysis"><i class="fas fa-exclamation-circle"></i><p>No analysis found</p></div>';
            analysisTitle.textContent = 'Race Analysis';
            raceInfo.style.display = 'none';
            return;
        }
        
        const analysis = raceAnalyses[key];
        
        // Format the analysis
        let formattedAnalysis = analysis.analysis
            .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/====+/g, '<hr>')
            .replace(/\n/g, '<br>');
        
        formattedAnalysis = formattedAnalysis.replace(/^- /g, '<br>- ');
        
        analysisContent.innerHTML = formattedAnalysis;
        analysisTitle.textContent = `${analysis.venue} - Race ${analysis.raceNo} Analysis`;
        
        // Update race info
        const dateObj = new Date(analysis.date);
        const formattedDate = dateObj.toLocaleDateString('en-IN', {
            weekday: 'long',
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        selectedVenue.textContent = analysis.venue;
        selectedDate.textContent = formattedDate;
        selectedRace.textContent = `Race ${analysis.raceNo}`;
        raceInfo.style.display = 'flex';
        
        // Update admin form
        adminVenue.value = analysis.venue;
        adminDate.value = analysis.date;
        adminRaceNo.value = analysis.raceNo;
        adminAnalysis.value = analysis.analysis;
    }

    /* ---------------------------------------------------
    EVENT HANDLERS (KV-ONLY)
    --------------------------------------------------- */
    // Save button - CREATE NEW
    saveBtn.addEventListener('click', async function() {
        const venue = adminVenue.value.trim();
        const date = adminDate.value;
        const raceNo = adminRaceNo.value.trim();
        const analysis = adminAnalysis.value.trim();
        
        if (!venue || !date || !raceNo || !analysis) {
            showToast('Please fill all fields', 'error');
            return;
        }
        
        const key = generateKey(venue, date, raceNo);
        const data = { venue, date, raceNo, analysis };
        
        // Check if already exists
        if (raceAnalyses[key]) {
            if (!confirm('Analysis already exists for this race. Update?')) {
                return;
            }
        }
        
        try {
            // Save to KV
            await saveToKV(key, data);
            
            // Update local state
            raceAnalyses[key] = data;
            
            showToast('‚úÖ Analysis saved to cloud!', 'success');
            
            // Refresh UI
            initializeDropdowns();
            venueSelect.value = venue;
            updateDateDropdown();
            raceSelect.value = key;
            displayAnalysis(key);
            
        } catch (error) {
            showToast(`‚ùå Failed to save to cloud: ${error.message}`, 'error');
            console.error("Save failed:", error);
        }
    });

    // Update button - UPDATE EXISTING
    updateBtn.addEventListener('click', async function() {
        const selectedKey = raceSelect.value;
        if (!selectedKey || !raceAnalyses[selectedKey]) {
            showToast('Select a race first', 'error');
            return;
        }
        
        const venue = adminVenue.value.trim();
        const date = adminDate.value;
        const raceNo = adminRaceNo.value.trim();
        const analysis = adminAnalysis.value.trim();
        
        if (!venue || !date || !raceNo || !analysis) {
            showToast('Please fill all fields', 'error');
            return;
        }
        
        const newKey = generateKey(venue, date, raceNo);
        const data = { venue, date, raceNo, analysis };
        
        try {
            // Save new entry to KV
            await saveToKV(newKey, data);
            
            // Delete old entry if key changed
            if (selectedKey !== newKey) {
                await deleteFromKV(selectedKey);
            }
            
            // Update local state
            if (selectedKey !== newKey) {
                delete raceAnalyses[selectedKey];
            }
            raceAnalyses[newKey] = data;
            
            showToast('‚úÖ Analysis updated in cloud!', 'success');
            
            // Refresh UI
            initializeDropdowns();
            raceSelect.value = newKey;
            displayAnalysis(newKey);
            
        } catch (error) {
            showToast(`‚ùå Failed to update in cloud: ${error.message}`, 'error');
            console.error("Update failed:", error);
        }
    });

    // Delete button
    deleteBtn.addEventListener('click', async function() {
        const selectedKey = raceSelect.value;
        if (!selectedKey || !raceAnalyses[selectedKey]) {
            showToast('Select a race first', 'error');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this analysis?')) {
            return;
        }
        
        try {
            // Delete from KV
            await deleteFromKV(selectedKey);
            
            // Delete from local state
            delete raceAnalyses[selectedKey];
            
            showToast('‚úÖ Analysis deleted from cloud!', 'success');
            
            // Refresh UI
            initializeDropdowns();
            
            // Clear analysis display
            analysisContent.innerHTML = '<div class="no-analysis"><i class="fas fa-racing-helmet"></i><p>Select a race to view analysis</p></div>';
            analysisTitle.textContent = 'Race Analysis';
            raceInfo.style.display = 'none';
            
        } catch (error) {
            showToast(`‚ùå Failed to delete from cloud: ${error.message}`, 'error');
            console.error("Delete failed:", error);
        }
    });

    // Clear button
    clearBtn.addEventListener('click', function() {
        adminVenue.value = '';
        adminDate.value = today;
        adminRaceNo.value = '';
        adminAnalysis.value = '';
        showToast('Form cleared', 'info');
    });


    // (Removed previous hideAdminBtn event listener that redirected to '/')

    // Dropdown events
    venueSelect.addEventListener('change', updateDateDropdown);
    dateSelect.addEventListener('change', updateRaceDropdown);
    raceSelect.addEventListener('change', function() {
        if (this.value) {
            displayAnalysis(this.value);
        } else {
            analysisContent.innerHTML = '<div class="no-analysis"><i class="fas fa-racing-helmet"></i><p>Select a race to view analysis</p></div>';
            analysisTitle.textContent = 'Race Analysis';
            raceInfo.style.display = 'none';
        }
    });

    /* ---------------------------------------------------
    CALENDAR FUNCTION
    --------------------------------------------------- */
    function createCalendar() {
        const todayObj = new Date();
        const currentMonth = todayObj.getMonth();
        const currentYear = todayObj.getFullYear();
        
        const monthNames = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];
        
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        
        let calendarHTML = `
            <div class="calendar-header">
                <h4>${monthNames[currentMonth]} ${currentYear}</h4>
            </div>
            <div class="calendar-grid">
                <div class="calendar-day-header">S</div>
                <div class="calendar-day-header">M</div>
                <div class="calendar-day-header">T</div>
                <div class="calendar-day-header">W</div>
                <div class="calendar-day-header">T</div>
                <div class="calendar-day-header">F</div>
                <div class="calendar-day-header">S</div>
        `;
        
        for (let i = 0; i < firstDay; i++) {
            calendarHTML += `<div class="calendar-day"></div>`;
        }
        
        const raceDays = [5, 12, 19, 26, 30];
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === todayObj.getDate() && currentMonth === todayObj.getMonth();
            const isRaceDay = raceDays.includes(day);
            
            let dayClass = 'calendar-day';
            if (isToday) dayClass += ' today';
            if (isRaceDay) dayClass += ' race-day';
            
            calendarHTML += `<div class="${dayClass}">${day}</div>`;
        }
        
        calendarHTML += `</div>`;
        calendarWidget.innerHTML = calendarHTML;
    }

    /* ---------------------------------------------------
    LOAD UPCOMING RACES FROM GOOGLE SHEETS
    --------------------------------------------------- */
    const SHEET_ID = '1fs_DhXWii9a7_XruGo1OuEJ0KIB7iQ3whDmHUOc3SEk';
    const SHEET_NAME = 'Sheet1';

    async function loadUpcomingRacesFromSheet() {
        const url = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;
        const list = document.getElementById('upcomingRaces');

        if (!list) {
            console.warn("upcomingRaces element not found");
            return;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const races = await response.json();
            
            // Clear loading message
            list.innerHTML = '';

            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);

            // Filter and sort upcoming races
            const upcoming = races
                .filter(r => r.venue && r.date)
                .filter(r => {
                    try {
                        const raceDate = new Date(r.date);
                        raceDate.setHours(0, 0, 0, 0);
                        return raceDate >= todayDate;
                    } catch (e) {
                        console.error("Error parsing date for race:", r);
                        return false;
                    }
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcoming.length === 0) {
                list.innerHTML = '<li>No upcoming major races</li>';
                return;
            }

            // Display upcoming races (limit to 5)
            upcoming.slice(0, 5).forEach(race => {
                try {
                    const dateObj = new Date(race.date);
                    const formattedDate = dateObj.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });

                    list.innerHTML += `
                        <li>
                            <span class="race-venue">${race.venue}</span>
                            <span class="race-date">${formattedDate}</span>
                        </li>
                    `;
                } catch (e) {
                    console.error("Error processing race:", race);
                }
            });

        } catch (err) {
            console.error("Failed to load upcoming races:", err);
            list.innerHTML = `
                <li style="color: #dc3545;">
                    <i class="fas fa-exclamation-circle"></i> Unable to load races
                </li>
            `;
        }
    }

    /* ---------------------------------------------------
    INITIALIZATION
    --------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', async function() {
        console.log("üöÄ Initializing RaceAnalyst Admin (KV-Only)...");
        
        try {
            // Load race analyses from Cloudflare KV
            const loadResult = await loadFromKV();
            
            // Initialize UI components
            initializeDropdowns();
            createCalendar();
            loadUpcomingRacesFromSheet(); // Load from Google Sheets
            
            // Auto-select the first analysis if available
            if (raceAnalyses && typeof raceAnalyses === 'object') {
                const allKeys = Object.keys(raceAnalyses);
                if (allKeys.length > 0) {
                    // Sort by date (newest first)
                    allKeys.sort((a, b) => {
                        const analysisA = raceAnalyses[a];
                        const analysisB = raceAnalyses[b];
                        
                        if (!analysisA || !analysisB || !analysisA.date || !analysisB.date) {
                            return 0;
                        }
                        
                        return analysisB.date.localeCompare(analysisA.date);
                    });
                    
                    const latestKey = allKeys[0];
                    const latest = raceAnalyses[latestKey];
                    
                    if (latest && latest.venue) {
                        venueSelect.value = latest.venue;
                        updateDateDropdown();
                        raceSelect.value = latestKey;
                        displayAnalysis(latestKey);
                    }
                } else {
                    console.log("No analyses found in KV storage");
                    showToast("No analyses found. Start by adding one!", "info");
                }
            }
            
            console.log("‚úÖ Admin page ready!");
            console.log("Analyses loaded:", raceAnalyses ? Object.keys(raceAnalyses).length : 0);
            
        } catch (error) {
            console.error("Initialization error:", error);
            showToast("Error initializing page. Please refresh.", "error");
            
            // Show error in analysis content
            analysisContent.innerHTML = `
                <div class="no-analysis">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading data</p>
                    <p style="font-size: 0.9rem; color: #dc3545;">${error.message}</p>
                </div>
            `;
        }
    });
    /* ---------------------------------------------------
    ADMIN PAGE NAVIGATION
    --------------------------------------------------- */
    document.getElementById("navRaceCalendar").addEventListener("click", function(e) {
        e.preventDefault();
        const calendar = document.querySelector('.sidebar-widget h3 i.fas.fa-calendar-alt').parentElement.parentElement;
        calendar.scrollIntoView({ behavior: 'smooth', block: 'start' });
        showToast('Viewing Race Calendar', 'info');
    });

    document.getElementById("navUpcomingRaces").addEventListener("click", function(e) {
        e.preventDefault();

        const trophyIcon = document.querySelector('.sidebar-widget h3 i.fas.fa-trophy');
        if (trophyIcon) {
            const widget = trophyIcon.closest('.sidebar-widget');
            widget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            showToast('Viewing Upcoming Races', 'info');
        } else {
            showToast('Upcoming Races widget not found', 'error');
        }
    });

    document.getElementById("navAnalysis").addEventListener("click", function(e) {
        e.preventDefault();
        const analysisCard = document.querySelector('.selection-card');
        analysisCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        showToast('Viewing Analysis', 'info');
    });

    /* ---------------------------------------------------
    MOBILE MENU FUNCTIONALITY
    --------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navMenu = document.getElementById('navMenu');
        const navOverlay = document.getElementById('navOverlay');
        
        if (mobileMenuBtn && navMenu && navOverlay) {
            mobileMenuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                navMenu.classList.toggle('active');
                navOverlay.classList.toggle('active');
                
                // Change icon based on state
                const icon = mobileMenuBtn.querySelector('i');
                if (navMenu.classList.contains('active')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                    document.body.style.overflow = 'hidden'; // Prevent scrolling
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                    document.body.style.overflow = 'auto'; // Restore scrolling
                }
            });
            
            // Close menu when clicking overlay
            navOverlay.addEventListener('click', function() {
                navMenu.classList.remove('active');
                navOverlay.classList.remove('active');
                const icon = mobileMenuBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
                document.body.style.overflow = 'auto'; // Restore scrolling
            });
            
            // Close menu when clicking a link
            const navLinks = navMenu.querySelectorAll('a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    navMenu.classList.remove('active');
                    navOverlay.classList.remove('active');
                    const icon = mobileMenuBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                    document.body.style.overflow = 'auto'; // Restore scrolling
                });
            });
            
            // Close menu when pressing Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && navMenu.classList.contains('active')) {
                    navMenu.classList.remove('active');
                    navOverlay.classList.remove('active');
                    const icon = mobileMenuBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                    document.body.style.overflow = 'auto'; // Restore scrolling
                }
            });
        }
    });

    /* ---------------------------------------------------
    CLOUDFLARE ZERO TRUST AUTHENTICATION
    --------------------------------------------------- */

    // Global auth state
    async function checkCloudflareAuth() {
        try {
            console.log("üîê Checking Cloudflare authentication...");
            
            // First, check if we have Cloudflare Access headers directly
            // This works when accessing directly via the domain with Cloudflare Access
            const cfEmail = document.cookie.match(/(?:^|;\s*)CF_AUTHORIZATION=([^;]*)/)?.[1];
            
            if (cfEmail) {
                console.log("‚úÖ Found Cloudflare Access cookie");
                currentUser = {
                    email: cfEmail,
                    name: cfEmail.split('@')[0],
                    authenticated: true
                };
                isAuthenticated = true;
                return { authenticated: true, user: currentUser };
            }
            
            // Try to get auth info from multiple possible sources
            const endpoints = [
                '/api/auth-status',
                '/cdn-cgi/access/get-identity'  // Cloudflare Access built-in endpoint
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log(`${endpoint} status:`, response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`${endpoint} data:`, data);
                        
                        // Check various possible auth indicators
                        if (data.authenticated === true || 
                            data.email || 
                            data.user?.email ||
                            data.success === true) {
                            
                            currentUser = {
                                email: data.email || data.user?.email || 'admin@raceanalyst.in',
                                name: data.name || data.user?.name || 'Admin',
                                authenticated: true
                            };
                            isAuthenticated = true;
                            
                            console.log(`‚úÖ Authenticated via ${endpoint}: ${currentUser.email}`);
                            return { 
                                authenticated: true, 
                                user: currentUser,
                                source: endpoint 
                            };
                        }
                    }
                } catch (error) {
                    console.warn(`Endpoint ${endpoint} failed:`, error.message);
                }
            }
            
            // If all else fails, try the direct Worker as last resort
            try {
                const directResponse = await fetch('https://broad-sound-fdb7.raceanalyst.workers.dev/auth-status', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (directResponse.ok) {
                    const data = await directResponse.json();
                    if (data.authenticated) {
                        currentUser = {
                            email: data.email || 'admin@raceanalyst.in',
                            name: data.name || 'Admin',
                            authenticated: true
                        };
                        isAuthenticated = true;
                        console.log("‚úÖ Authenticated via direct Worker");
                        return { authenticated: true, user: currentUser };
                    }
                }
            } catch (error) {
                console.warn("Direct Worker check failed:", error.message);
            }
            
            // Not authenticated
            console.log("‚ùå Not authenticated - no valid auth found");
            currentUser = null;
            isAuthenticated = false;
            return { authenticated: false, user: null };
            
        } catch (error) {
            console.error("Auth check failed:", error);
            currentUser = null;
            isAuthenticated = false;
            return { authenticated: false, user: null };
        }
    }

    /* ---------------------------------------------------
    LOGIN/LOGOUT FUNCTIONS
    --------------------------------------------------- */
    // async function loginToCloudflare() {
    //     try {
    //         console.log("üîë Initiating Cloudflare login...");
            
    //         // Force Cloudflare to show login by requesting a protected endpoint
    //         // This should trigger the Cloudflare Access login flow
    //         const loginUrl = `${workerBase}/protected-endpoint`;
            
    //         // Try to access protected endpoint - Cloudflare will redirect to login
    //         const response = await fetch(loginUrl, {
    //             method: 'GET',
    //             credentials: 'include',
    //             redirect: 'manual' // Don't follow redirects automatically
    //         });
            
    //         console.log("Login response status:", response.status);
            
    //         if (response.status === 0 || response.status === 302) {
    //             // Cloudflare is redirecting to login
    //             console.log("Cloudflare redirecting to login page");
                
    //             // Show message to user
    //             showToast('Redirecting to login page...', 'info');
                
    //             // Force page reload which should trigger Cloudflare login
    //             setTimeout(() => {
    //                 window.location.reload();
    //             }, 1000);
                
    //             return true;
    //         }
            
    //         // If we get here, something unexpected happened
    //         showToast('Could not initiate login. Please try again.', 'error');
    //         return false;
            
    //     } catch (error) {
    //         console.error("Login initiation failed:", error);
    //         showToast('Login error: ' + error.message, 'error');
    //         return false;
    //     }
    // }

    async function loginToCloudflare() {
        console.log("üîë Forcing Cloudflare Access login...");

        // This special URL ALWAYS triggers Cloudflare Access login
        window.location.href = "https://raceanalyst.pages.dev/admin";
    }

    async function logoutFromCloudflare() {
        try {
            console.log("üö™ Logging out from Cloudflare...");
            
            // Cloudflare Access logout - typically redirects to logout endpoint
            const logoutUrl = `${workerBase}/cdn-cgi/access/logout`;
            
            showToast('Logging out...', 'info');
            
            // Redirect to logout URL
            setTimeout(() => {
                window.location.href = logoutUrl;
            }, 500);
            
            return true;
            
        } catch (error) {
            console.error("Logout failed:", error);
            showToast('Logout error: ' + error.message, 'error');
            return false;
        }
    }

    /* ---------------------------------------------------
    UPDATE UI BASED ON AUTH STATUS
    --------------------------------------------------- */
/* ---------------------------------------------------
    UPDATE UI BASED ON AUTH STATUS
    --------------------------------------------------- */
    async function updateUIForAuthStatus(authResult) {
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const logoutItem = document.getElementById('logoutItem');
        
        if (authResult.authenticated) {
            // User is authenticated
            isAuthenticated = true;
            
            if (adminLoginBtn) {
                adminLoginBtn.innerHTML = `
                    <i class="fas fa-user-check"></i> 
                    ${authResult.user.name || authResult.user.email || 'Admin'}
                `;
                adminLoginBtn.style.color = '#4CAF50';
                adminLoginBtn.removeAttribute('href');
                adminLoginBtn.onclick = null;
                adminLoginBtn.style.cursor = 'default';
            }
            
            if (logoutItem) {
                logoutItem.style.display = 'block';
            }
            
            // Show admin panel automatically if authenticated
            adminPanel.style.display = 'block';
            
            // Reload data with admin privileges
            console.log("üîÑ Reloading data with admin access...");
            await loadFromKV();
            initializeDropdowns();
            
            showToast(`Welcome ${authResult.user.name || authResult.user.email || 'Admin'}!`, 'success');
            
        } else {
            // User is not authenticated
            isAuthenticated = false;
            
            if (adminLoginBtn) {
                adminLoginBtn.innerHTML = '<i class="fas fa-user-lock"></i> Login as Admin';
                adminLoginBtn.style.color = '#d4af37';
                adminLoginBtn.href = '#';
                adminLoginBtn.onclick = async (e) => {
                    e.preventDefault();
                    await loginToCloudflare();
                };
            }
            
            if (logoutItem) {
                logoutItem.style.display = 'none';
            }
            
            // Hide admin panel
            adminPanel.style.display = 'none';
            
            // Load data with public access
            console.log("üìñ Loading data with public access...");
            await loadFromKV();
            initializeDropdowns();
        }
    }

    // Debug function to check headers
    async function debugHeaders() {
        try {
            const response = await fetch(workerBase + "/debug-headers", {
                method: 'GET',
                credentials: 'include'
            });
            
            const data = await response.json();
            console.log("üìã Headers debug:", data);
            return data;
        } catch (error) {
            console.error("Debug failed:", error);
            return { error: error.message };
        }
    }

    async function requireAuth(actionName = 'perform this action') {
        const authResult = await checkCloudflareAuth();

        if (!authResult.authenticated) {
            showToast(`Please login to ${actionName}`, 'error');

            setTimeout(() => {
                if (confirm(`Admin access requires authentication. Login now?`)) {
                    loginToCloudflare();
                }
            }, 500);

            return false;
        }

        updateUIForAuthStatus(authResult);
        return true;
    }

    /* ---------------------------------------------------
    PROTECTED ACTION WRAPPER
    --------------------------------------------------- */
    // async function requireAuth(actionName = 'perform this action') {
    //     if (!isAuthenticated) {
    //         const authResult = await checkCloudflareAuth();
            
    //         if (!authResult.authenticated) {
    //             showToast(`Please login to ${actionName}`, 'error');
                
    //             // Ask user if they want to login
    //             setTimeout(() => {
    //                 if (confirm(`Admin access requires authentication. Would you like to login now?`)) {
    //                     loginToCloudflare();
    //                 }
    //             }, 500);
                
    //             return false;
    //         }
            
    //         // Update UI since we just authenticated
    //         updateUIForAuthStatus(authResult);
    //     }
        
    //     return true;
    // }

    
    /* ---------------------------------------------------
    UPDATE EVENT HANDLERS
    --------------------------------------------------- */
    // Save button - with auth check
    saveBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        
        const canProceed = await requireAuth('save analysis');
        if (!canProceed) return;
        
        // Original save logic
        const venue = adminVenue.value.trim();
        const date = adminDate.value;
        const raceNo = adminRaceNo.value.trim();
        const analysis = adminAnalysis.value.trim();
        
        if (!venue || !date || !raceNo || !analysis) {
            showToast('Please fill all fields', 'error');
            return;
        }
        
        const key = generateKey(venue, date, raceNo);
        const data = { venue, date, raceNo, analysis };
        
        // Check if already exists
        if (raceAnalyses[key]) {
            if (!confirm('Analysis already exists for this race. Update?')) {
                return;
            }
        }
        
        try {
            // Save to KV
            await saveToKV(key, data);
            
            // Update local state
            raceAnalyses[key] = data;
            
            showToast('‚úÖ Analysis saved to cloud!', 'success');
            
            // Refresh UI
            initializeDropdowns();
            venueSelect.value = venue;
            updateDateDropdown();
            raceSelect.value = key;
            displayAnalysis(key);
            
        } catch (error) {
            showToast(`‚ùå Failed to save: ${error.message}`, 'error');
            console.error("Save failed:", error);
        }
    });


/* ---------------------------------------------------
    EVENT LISTENERS FOR LOGIN/LOGOUT - SAFE VERSION
    --------------------------------------------------- */
    function setupAuthEventListeners() {
        // Login button - check if element exists
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        if (adminLoginBtn) {
            adminLoginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                
                if (!isAuthenticated) {
                    await loginToCloudflare();
                }
            });
        } else {
            console.warn('adminLoginBtn element not found');
        }
        
        // Logout button - check if element exists
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await logoutFromCloudflare();
            });
        } else {
            console.log('logoutBtn not found (normal when not logged in)');
        }
    }
    // Update button - with auth check
    updateBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        
        const canProceed = await requireAuth('update analysis');
        if (!canProceed) return;
        
        // Original update logic
        const selectedKey = raceSelect.value;
        if (!selectedKey || !raceAnalyses[selectedKey]) {
            showToast('Select a race first', 'error');
            return;
        }
        
        const venue = adminVenue.value.trim();
        const date = adminDate.value;
        const raceNo = adminRaceNo.value.trim();
        const analysis = adminAnalysis.value.trim();
        
        if (!venue || !date || !raceNo || !analysis) {
            showToast('Please fill all fields', 'error');
            return;
        }
        
        const newKey = generateKey(venue, date, raceNo);
        const data = { venue, date, raceNo, analysis };
        
        try {
            // Save new entry to KV
            await saveToKV(newKey, data);
            
            // Delete old entry if key changed
            if (selectedKey !== newKey) {
                await deleteFromKV(selectedKey);
            }
            
            // Update local state
            if (selectedKey !== newKey) {
                delete raceAnalyses[selectedKey];
            }
            raceAnalyses[newKey] = data;
            
            showToast('‚úÖ Analysis updated in cloud!', 'success');
            
            // Refresh UI
            initializeDropdowns();
            raceSelect.value = newKey;
            displayAnalysis(newKey);
            
        } catch (error) {
            showToast(`‚ùå Failed to update: ${error.message}`, 'error');
            console.error("Update failed:", error);
        }
    });

    // Delete button - with auth check
    deleteBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        
        const canProceed = await requireAuth('delete analysis');
        if (!canProceed) return;
        
        const selectedKey = raceSelect.value;
        if (!selectedKey || !raceAnalyses[selectedKey]) {
            showToast('Select a race first', 'error');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this analysis?')) {
            return;
        }
        
        try {
            // Delete from KV
            await deleteFromKV(selectedKey);
            
            // Delete from local state
            delete raceAnalyses[selectedKey];
            
            showToast('‚úÖ Analysis deleted from cloud!', 'success');
            
            // Refresh UI
            initializeDropdowns();
            
            // Clear analysis display
            analysisContent.innerHTML = '<div class="no-analysis"><i class="fas fa-racing-helmet"></i><p>Select a race to view analysis</p></div>';
            analysisTitle.textContent = 'Race Analysis';
            raceInfo.style.display = 'none';
            
        } catch (error) {
            showToast(`‚ùå Failed to delete: ${error.message}`, 'error');
            console.error("Delete failed:", error);
        }
    });

    /* ---------------------------------------------------
    UPDATE ADMIN PANEL TOGGLE
    --------------------------------------------------- */
    const adminMenuItem = document.getElementById('adminLoginBtn');
    if (adminMenuItem) {
        adminMenuItem.addEventListener('click', async (e) => {
            e.preventDefault();
            const canProceed = await requireAuth('access admin panel');
            if (!canProceed) return;

            adminPanel.style.display = 'block';
            showToast(`Welcome ${currentUser?.name || currentUser?.email || 'Admin'}!`, 'success');
        });
    }

    // Hide admin panel
    hideAdminBtn.addEventListener('click', () => {
        adminPanel.style.display = 'none';
    });

    /* ---------------------------------------------------
    UPDATE INITIALIZATION
    --------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', async function() {
        console.log("üöÄ Initializing RaceAnalyst Admin with Cloudflare Auth...");
        
        try {
            // Set up event listeners
            setupAuthEventListeners();
            
            // First check authentication
            const authResult = await checkCloudflareAuth();
            
            // Update UI based on auth status
            updateUIForAuthStatus(authResult);
            
            // Load race analyses from Cloudflare KV
            const loadResult = await loadFromKV();
            
            // Initialize UI components
            initializeDropdowns();
            createCalendar();
            loadUpcomingRacesFromSheet();
            
            // Auto-select the first analysis if available
            if (raceAnalyses && typeof raceAnalyses === 'object') {
                const allKeys = Object.keys(raceAnalyses);
                if (allKeys.length > 0) {
                    allKeys.sort((a, b) => {
                        const analysisA = raceAnalyses[a];
                        const analysisB = raceAnalyses[b];
                        
                        if (!analysisA || !analysisB || !analysisA.date || !analysisB.date) {
                            return 0;
                        }
                        
                        return analysisB.date.localeCompare(analysisA.date);
                    });
                    
                    const latestKey = allKeys[0];
                    const latest = raceAnalyses[latestKey];
                    
                    if (latest && latest.venue) {
                        venueSelect.value = latest.venue;
                        updateDateDropdown();
                        raceSelect.value = latestKey;
                        displayAnalysis(latestKey);
                    }
                }
            }
            
            console.log("‚úÖ Admin page ready!");
            console.log("Auth status:", isAuthenticated ? 'Authenticated' : 'Not authenticated');
            
        } catch (error) {
            console.error("Initialization error:", error);
            showToast("Error loading page: " + error.message, "error");
            
            analysisContent.innerHTML = `
                <div class="no-analysis">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading data</p>
                    <p style="font-size: 0.9rem; color: #dc3545;">${error.message}</p>
                </div>
            `;
        }
    });

    async function debugAuthResponse() {
    try {
        console.log("üîç FULL AUTH DEBUG...");
        
        // Test 1: Check current page URL and cookies
        console.log("Current URL:", window.location.href);
        console.log("Cookies enabled:", navigator.cookieEnabled);
        console.log("Document cookies:", document.cookie);
        
        // Test 2: Try to fetch with different options
        const timestamp = new Date().getTime();
        const testUrls = [
            `${workerBase}/auth-status?t=${timestamp}`,
            `${workerBase}/auth-status?t=${timestamp}&debug=1`,
            workerBase // root to see if worker is responding
        ];
        
        for (let url of testUrls) {
            console.log(`\n--- Testing URL: ${url} ---`);
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include', // Important for sending cookies
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                console.log(`Status: ${response.status} ${response.statusText}`);
                console.log("Headers:");
                response.headers.forEach((value, key) => {
                    console.log(`  ${key}: ${value}`);
                });
                
                const text = await response.text();
                console.log("Response length:", text.length);
                
                if (text.length < 1000) {
                    console.log("Response content:", text);
                } else {
                    console.log("Response (first 500 chars):", text.substring(0, 500));
                }
                
                // Try to parse as JSON
                try {
                    const json = JSON.parse(text);
                    console.log("Parsed JSON:", JSON.stringify(json, null, 2));
                } catch(e) {
                    console.log("Not valid JSON");
                }
                
            } catch (error) {
                console.error(`Fetch error for ${url}:`, error.message);
            }
        }
        
        // Test 3: Try a direct Cloudflare Access check
        console.log("\n--- Checking Cloudflare Access Headers ---");
        try {
            const response = await fetch(`${workerBase}/`, {
                method: 'GET',
                credentials: 'include'
            });
            
            // Check for specific Cloudflare Access headers
            const headers = {};
            for (let [key, value] of response.headers.entries()) {
                if (key.toLowerCase().includes('cf-access') || 
                    key.toLowerCase().includes('cf-connecting') ||
                    key.toLowerCase().includes('authorization')) {
                    headers[key] = value;
                }
            }
            
            console.log("Cloudflare related headers:", headers);
            
        } catch (error) {
            console.error("CF Access check failed:", error);
        }
        
        return "Debug complete";
        
    } catch (error) {
        console.error("Debug function error:", error);
        return { error: error.message };
    }
}
    </script>
</body>
</html>
