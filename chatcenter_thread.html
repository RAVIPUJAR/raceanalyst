<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Thread | RaceAnalyst</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body {
            margin: 0;
            background: #f7f8fa;
            font-family: 'Source Serif Pro', serif;
        }

        header {
            background: #1a3c34;
            padding: 1rem 0;
            color: white;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
        }

        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.7rem;
            font-weight: 600;
        }

        .card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.8rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .message-box {
            background: #eef2f3;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .meta {
            font-size: 0.85rem;
            color: #666;
        }

        .msg-actions {
            margin-top: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            margin-right: 12px;
        }

        .action-btn.delete {
            color: #c62828;
        }

        .reply-thread {
            margin-left: 20px;
            border-left: 2px solid #d4af37;
            padding-left: 12px;
            margin-top: 10px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e6e6e6;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: 'Source Serif Pro';
        }

        button {
            background: #1a3c34;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            color: white;
            font-family: 'Montserrat';
            font-weight: 600;
            cursor: pointer;
        }

        button:hover {
            background: #244e44;
        }
        .avatar-option {
            font-size: 2rem;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .avatar-option.selected {
            border-color: #1a3c34;
            background: #e8f3ef;
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <span class="page-title"><i class="fas fa-comment-dots"></i> Chat Thread</span>
    </div>
</header>

<div class="container">
    <div class="card">
        <h2 id="topicTitle">Loading topic...</h2>
        <div id="messagesList">Loading messages...</div>

        <div style="margin-bottom:1.2rem;">
            <label style="font-weight:600;">Your Name</label>
            <input id="usernameInput" placeholder="Enter your name..." />
        </div>
        <div style="margin-bottom:1.2rem;">
            <label style="font-weight:600;">Choose an Avatar</label>
            <div id="avatarGrid" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <div class="avatar-option" data-avatar="üôÇ">üôÇ</div>
                <div class="avatar-option" data-avatar="üòé">üòé</div>
                <div class="avatar-option" data-avatar="üêé">üêé</div>
                <div class="avatar-option" data-avatar="üî•">üî•</div>
                <div class="avatar-option" data-avatar="üåü">üåü</div>
            </div>
        </div>
        <h3 style="margin-top:2rem;">Add a Reply</h3>
        <textarea id="replyText" placeholder="Write your reply..." style="min-height:120px;"></textarea>
        <button onclick="submitReply()">Reply</button>
    </div>
</div>

 <script>
// Global variables
let username = localStorage.getItem("chatUserName") || "";
let avatar = localStorage.getItem("chatUserAvatar") || "";
window.addEventListener("DOMContentLoaded", () => {
    const nameInput = document.getElementById("usernameInput");
    if (nameInput) {
        nameInput.value = username;
        nameInput.addEventListener("input", () => {
            username = nameInput.value.trim();
            localStorage.setItem("chatUserName", username);
        });
    }
    const avatarGrid = document.getElementById("avatarGrid");
    if (avatarGrid) {
        const options = avatarGrid.querySelectorAll(".avatar-option");
        options.forEach(opt => {
            if (opt.dataset.avatar === avatar) {
                opt.classList.add("selected");
            }
            opt.addEventListener("click", () => {
                options.forEach(o => o.classList.remove("selected"));
                opt.classList.add("selected");
                avatar = opt.dataset.avatar;
                localStorage.setItem("chatUserAvatar", avatar);
            });
        });
    }
});
let topicId = new URLSearchParams(window.location.search).get("topic");
let allTopics = [];
let currentTopic = null;

// Updated endpoint URLs
const BASE_URL = "https://broad-sound-fdb7.raceanalyst.workers.dev";
const GET_TOPICS_URL = `${BASE_URL}/chatcenter/get-topics`;
const SAVE_TOPICS_URL = `${BASE_URL}/chatcenter/save-topics`;

// 1. FIXED: Renamed from loadTopic() to loadTopics() 
async function loadTopics() {
  try {
    console.log("Loading topics from:", GET_TOPICS_URL);
    console.log("Topic ID from URL:", topicId);
    
    const res = await fetch(GET_TOPICS_URL);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    allTopics = Array.isArray(data) ? data : [];
    console.log("Loaded topics count:", allTopics.length);
    console.log("All topics:", allTopics);

    if (!topicId) {
      document.getElementById("topicTitle").innerHTML = "No topic ID specified";
      document.getElementById("messagesList").innerHTML = 
        '<div class="message-box"><p>Please go back and select a topic.</p></div>';
      return;
    }

    // Find the current topic
    currentTopic = allTopics.find(t => t.id === topicId);
    console.log("Found topic:", currentTopic);

    if (!currentTopic) {
      document.getElementById("topicTitle").innerHTML = "Topic not found";
      document.getElementById("messagesList").innerHTML = 
        `<div class="message-box"><p>Topic with ID "${topicId}" doesn't exist.</p></div>`;
      return;
    }

    // Initialize messages array if it doesn't exist
    if (!currentTopic.messages) {
      currentTopic.messages = [];
    }

    document.getElementById("topicTitle").innerHTML = currentTopic.title || "Untitled Topic";
    renderMessages();
    
  } catch (error) {
    console.error("Failed to load topics:", error);
    document.getElementById("topicTitle").innerHTML = "Error Loading Chat";
    document.getElementById("messagesList").innerHTML = 
      `<div class="message-box" style="background:#ffe6e6;">
         <p><strong>Connection Error:</strong> Could not load chat messages.</p>
         <p>Please check your internet connection and try again.</p>
         <p><small>Error: ${error.message}</small></p>
       </div>`;
  }
}

// 2. Render thread messages
function renderMessages() {
  const list = document.getElementById("messagesList");
  
  // Check if currentTopic exists
  if (!currentTopic) {
    list.innerHTML = `<div class="message-box"><p>Topic not loaded.</p></div>`;
    return;
  }
  
  // Check if messages exist
  if (!currentTopic.messages || currentTopic.messages.length === 0) {
    list.innerHTML = `<div class="message-box"><p>No messages yet. Start the conversation!</p></div>`;
    return;
  }
  
  list.innerHTML = currentTopic.messages
    .map(msg => renderMessage(msg))
    .join("");
}

// 3. Render single message including nested replies
function renderMessage(msg) {
  return `
    <div class="message-box" id="msg-${msg.id}">
      <strong>${msg.avatar || "üôÇ"} ${msg.user || "Anonymous"}</strong>
      <p>${msg.text || ""}</p>
      <span class="meta">${msg.date || new Date().toLocaleString()}</span>

      <div class="msg-actions">
        <button class="action-btn" onclick="likeMessage('${msg.id}')">
          üëç ${msg.likes || 0}
        </button>
        <button class="action-btn" onclick="showReplyBox('${msg.id}')">
          Reply
        </button>
        <button class="action-btn delete" onclick="deleteMessage('${msg.id}')">
          Delete
        </button>
      </div>

      <div id="replyBox-${msg.id}" style="display:none; margin-top:10px;">
        <textarea id="replyInput-${msg.id}" placeholder="Write reply..." style="min-height:80px;"></textarea>
        <button onclick="submitNestedReply('${msg.id}')">Submit Reply</button>
        <button onclick="hideReplyBox('${msg.id}')" style="margin-left:10px; background:#666;">Cancel</button>
      </div>

      <div class="reply-thread">
        ${(msg.replies || []).map(r => renderMessage(r)).join("")}
      </div>
    </div>
  `;
}

// 4. Show/hide reply input
function showReplyBox(id) {
  document.getElementById(`replyBox-${id}`).style.display = "block";
  document.getElementById(`replyInput-${id}`).focus();
}

function hideReplyBox(id) {
  document.getElementById(`replyBox-${id}`).style.display = "none";
  document.getElementById(`replyInput-${id}`).value = "";
}

// 5. Like a message
async function likeMessage(id) {
  if (!currentTopic) return;
  
  let msg = findMessage(currentTopic.messages, id);
  if (msg) {
    msg.likes = (msg.likes || 0) + 1;
    await saveTopics();
    renderMessages();
  }
}

// 6. Delete a message
async function deleteMessage(id) {
  if (!currentTopic) return;
  if (!confirm("Are you sure you want to delete this message?")) return;
  
  currentTopic.messages = removeMessage(currentTopic.messages, id);
  await saveTopics();
  renderMessages();
}

function removeMessage(arr, id) {
  return arr.filter(m => {
    if (m.id === id) return false;
    if (m.replies) m.replies = removeMessage(m.replies, id);
    return true;
  });
}

function findMessage(arr, id) {
  for (let m of arr) {
    if (m.id === id) return m;
    if (m.replies) {
      let found = findMessage(m.replies, id);
      if (found) return found;
    }
  }
  return null;
}

// 7. Submit nested reply
async function submitNestedReply(parentId) {
  if (!currentTopic) {
    alert("Topic not loaded. Please refresh the page.");
    return;
  }
  
  const box = document.getElementById(`replyInput-${parentId}`);
  const text = box.value.trim();
  
  if (!text) {
    alert("Reply cannot be empty.");
    return;
  }
  
  let parent = findMessage(currentTopic.messages, parentId);
  if (!parent) {
    alert("Parent message not found.");
    return;
  }
  
  if (!parent.replies) parent.replies = [];
  
  parent.replies.push({
    id: Date.now().toString(),
    user: username || "Anonymous",
    avatar: avatar || "üôÇ",
    text,
    date: new Date().toLocaleString(),
    likes: 0,
    replies: []
  });

  box.value = "";
  hideReplyBox(parentId);
  await saveTopics();
  renderMessages();
}

// 8. Main reply for the thread - FIXED NULL CHECK
async function submitReply() {
  // Check if currentTopic exists
  if (!currentTopic) {
    alert("Topic not loaded. Please refresh the page.");
    return;
  }
  
  const textarea = document.getElementById("replyText");
  const text = textarea.value.trim();
  
  if (!text) {
    alert("Reply cannot be empty.");
    return;
  }
  
  // Initialize messages array if it doesn't exist
  if (!currentTopic.messages) {
    currentTopic.messages = [];
  }
  
  currentTopic.messages.push({
    id: Date.now().toString(),
    user: username || "Anonymous",
    avatar: avatar || "üôÇ",
    text,
    date: new Date().toLocaleString(),
    likes: 0,
    replies: []
  });

  textarea.value = "";
  await saveTopics();
  renderMessages();
}

// 9. Save to KV with retry logic
async function saveTopics() {
  if (!currentTopic) {
    console.error("Cannot save: currentTopic is null");
    return;
  }
  
  try {
    console.log("Saving topics to:", SAVE_TOPICS_URL);
    
    // Update the topic in allTopics array
    const topicIndex = allTopics.findIndex(t => t.id === currentTopic.id);
    if (topicIndex !== -1) {
      allTopics[topicIndex] = currentTopic;
    } else {
      allTopics.push(currentTopic);
    }
    
    const response = await fetch(SAVE_TOPICS_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(allTopics)
    });
    
    if (!response.ok) {
      throw new Error(`Save failed: ${response.status}`);
    }
    
    const result = await response.json();
    console.log("Save successful:", result);
    return result;
    
  } catch (error) {
    console.error("Failed to save topics:", error);
    alert("Failed to save changes. Please try again.");
    throw error;
  }
}

// 10. Initialize - FIXED: Changed from loadTopic() to loadTopics()
window.addEventListener('DOMContentLoaded', () => {
  console.log("Chat thread initialized with topic ID:", topicId);
  loadTopics(); // This was calling loadTopic() which didn't exist
});

// Make functions available globally
window.loadTopics = loadTopics;
window.renderMessages = renderMessages;
window.showReplyBox = showReplyBox;
window.hideReplyBox = hideReplyBox;
window.likeMessage = likeMessage;
window.deleteMessage = deleteMessage;
window.submitNestedReply = submitNestedReply;
window.submitReply = submitReply;
window.saveTopics = saveTopics;
</script>

</body>
</html>
