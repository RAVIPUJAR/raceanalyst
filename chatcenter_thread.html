import { getAnalysis, saveAnalysis, deleteAnalysis } from "./analysis.js";

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const kv = env.MY_KV_NAMESPACE;

    // Handle OPTIONS requests first
    if (request.method === "OPTIONS") {
      return handleCors(request);
    }

    // ---- EXISTING ANALYSIS ENDPOINTS ----
    if (url.pathname === "/analysis/get" && request.method === "GET") {
      const data = await getAnalysis(kv);
      return cors(
        new Response(JSON.stringify(data), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    if (url.pathname === "/analysis/save" && request.method === "POST") {
      const body = await request.json();
      await saveAnalysis(kv, body);
      return cors(
        new Response(JSON.stringify({ status: "ok" }), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    if (url.pathname === "/analysis/delete" && request.method === "POST") {
      const body = await request.json();
      await deleteAnalysis(kv, body.id);
      return cors(
        new Response(JSON.stringify({ status: "deleted" }), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    // ---- GET ALL CHAT TOPICS ----
    if (url.pathname === "/feedback/get-topics" && request.method === "GET") {
      const data = await kv.get("chat_topics", "json");
      return cors(
        new Response(JSON.stringify(data || []), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    // ---- SAVE / UPDATE CHAT TOPICS ----
    if (url.pathname === "/feedback/save-topics" && request.method === "POST") {
      const body = await request.json();
      await kv.put("chat_topics", JSON.stringify(body));
      return cors(
        new Response(JSON.stringify({ status: "ok" }), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    // ---- SAVE CHAT MESSAGES ----
    if (url.pathname === "/chat/save" && request.method === "POST") {
      const body = await request.json();
      const { topicId, messages } = body;
      
      if (!topicId || !messages) {
        return cors(
          new Response(JSON.stringify({ error: "Missing topicId or messages" }), { 
            status: 400,
            headers: { "Content-Type": "application/json" } 
          }),
          request
        );
      }
      
      // Save messages for this topic
      await kv.put(`chat_${topicId}`, JSON.stringify(messages));
      
      return cors(
        new Response(JSON.stringify({ status: "ok" }), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    // ---- GET CHAT MESSAGES FOR A TOPIC ----
    if (url.pathname === "/chat/get" && request.method === "GET") {
      const topicId = url.searchParams.get("topicId");
      
      if (!topicId) {
        return cors(
          new Response(JSON.stringify({ error: "Missing topicId" }), { 
            status: 400,
            headers: { "Content-Type": "application/json" } 
          }),
          request
        );
      }
      
      const messages = await kv.get(`chat_${topicId}`, "json");
      
      return cors(
        new Response(JSON.stringify(messages || []), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    // ---- DELETE CHAT MESSAGES FOR A TOPIC ----
    if (url.pathname === "/chat/delete" && request.method === "POST") {
      const body = await request.json();
      const { topicId } = body;
      
      if (!topicId) {
        return cors(
          new Response(JSON.stringify({ error: "Missing topicId" }), { 
            status: 400,
            headers: { "Content-Type": "application/json" } 
          }),
          request
        );
      }
      
      await kv.delete(`chat_${topicId}`);
      
      return cors(
        new Response(JSON.stringify({ status: "deleted" }), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    // ---- GET ALL CHATS (for listing) ----
    if (url.pathname === "/chat/list" && request.method === "GET") {
      // Note: KV doesn't support listing keys by prefix in the same way
      // You might need to maintain a separate list of chat topics
      const topics = await kv.get("chat_topics", "json") || [];
      const chats = [];
      
      // For each topic, get the last message or metadata
      for (const topic of topics) {
        const messages = await kv.get(`chat_${topic.id}`, "json") || [];
        if (messages.length > 0) {
          chats.push({
            topicId: topic.id,
            topicName: topic.name,
            lastMessage: messages[messages.length - 1],
            messageCount: messages.length,
            lastUpdated: new Date().toISOString() // You should store this timestamp
          });
        }
      }
      
      return cors(
        new Response(JSON.stringify(chats), { 
          headers: { "Content-Type": "application/json" } 
        }),
        request
      );
    }

    return new Response("Not found", { status: 404 });
  }
};

function handleCors(request) {
  return new Response(null, {
    headers: {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    }
  });
}

function cors(response, request) {
  const headers = {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
  };
  
  // Clone response and add CORS headers
  const newResponse = new Response(response.body, response);
  for (const [key, value] of Object.entries(headers)) {
    newResponse.headers.set(key, value);
  }
  
  return newResponse;
}
