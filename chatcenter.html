<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Center | RaceAnalyst</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body {
            margin: 0;
            background: #f7f8fa;
            font-family: 'Source Serif Pro', serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: #1a3c34;
            padding: 1rem 0;
            color: white;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
            flex: 1;
        }

        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.8rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e6e6e6;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: 'Source Serif Pro';
            font-size: 1rem;
        }

        button {
            background: #1a3c34;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            color: white;
            font-family: 'Montserrat';
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #244e44;
            transform: translateY(-2px);
        }

        button.admin-btn {
            background: #d4af37;
        }

        button.delete-btn {
            background: #c62828;
        }

        footer {
            background: #1a3c34;
            color: white;
            padding: 1.5rem 0;
            margin-top: 3rem;
            text-align: center;
        }

        .footer-content {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .footer-links {
            display: flex;
            gap: 1.5rem;
        }

        .footer-links a {
            color: #d4af37;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: white;
        }

        /* Collapsible section styles */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 1rem;
            background: #f0f7f4;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .collapsible-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1a3c34;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 500px;
        }

        /* Topic item hover effects */
        .topic-item {
            transition: all 0.3s ease;
        }

        .topic-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: #f0f7f4 !important;
        }
    </style>
</head>
<body>

<!-- Header -->
<header>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="page-title">
                <i class="fas fa-comments"></i> RaceAnalyst Chat Center
            </span>
            <div id="adminButtonContainer"></div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container">
    
    <!-- Collapsible New Chat Topic Section -->
    <div class="card" id="newTopicSection">
        <div class="collapsible-header" onclick="toggleNewTopicSection()">
            <h2>
                <i class="fas fa-plus-circle"></i> New Chat Topic
                <span id="newTopicIndicator" style="font-size: 0.9rem; color: #666; font-weight: normal; margin-left: 1rem;">
                    (Click to expand/collapse)
                </span>
            </h2>
            <i class="fas fa-chevron-down" id="newTopicArrow"></i>
        </div>
        
        <div class="collapsible-content" id="newTopicContent">
            <input type="text" id="topicTitle" placeholder="Topic Title (e.g., 'Mumbai Race - Final Thoughts')">
            <textarea id="topicBody" placeholder="Write the first message for this topic..." style="min-height:120px;"></textarea>
            <div style="display: flex; gap: 1rem;">
                <button onclick="createTopic()" style="background: #1a3c34;">
                    <i class="fas fa-paper-plane"></i> Create Topic
                </button>
                <button onclick="clearNewTopicForm()" style="background: #666;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Topics List -->
    <div class="card" id="topicsCard">
        <h2 style="color: #1a3c34; display: flex; align-items: center; gap: 0.5rem; margin-top: 0;">
            <i class="fas fa-comments"></i> All Chat Topics
        </h2>
        
        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanel" style="display:none; margin-bottom:1rem; padding:1rem; background:#f0f7f4; border-radius:6px;">
            <div style="display:flex; align-items:center; gap:1rem;">
                <i class="fas fa-user-shield" style="color:#1a3c34;"></i>
                <span style="font-weight:600;">Admin Mode Active</span>
                <button onclick="toggleAdminMode(false)" style="margin-left:auto; padding:0.3rem 0.8rem; background:#c62828; color:white; border:none; border-radius:4px; cursor:pointer;">
                    Exit Admin
                </button>
            </div>
        </div>
        
        <div id="topicsList">Loading topics...</div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="footer-content">
        <div>
            <p style="margin: 0; color: #d4af37; font-weight: 600;">RaceAnalyst Chat Center</p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Real-time discussions for racing enthusiasts</p>
        </div>
        <div class="footer-links">
            <a href="https://raceanalyst.pages.dev" target="_blank"><i class="fas fa-home"></i> Home</a>
            <a href="#" onclick="showAdminLogin()"><i class="fas fa-user-shield"></i> Admin</a>
            <a href="#" onclick="loadTopics()"><i class="fas fa-sync-alt"></i> Refresh</a>
        </div>
    </div>
</footer>

<!-- Hidden Chat Thread Container -->
<div id="chatOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
    <div id="chatContainer" style="background:white; width:90%; max-width:800px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column;">
        <!-- Chat Header -->
        <div style="background:linear-gradient(135deg, #1a3c34 0%, #244e44 100%); color:white; padding:1.2rem; border-radius:12px 12px 0 0;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div style="flex:1;">
                    <div id="chatTopicTitle">
                        <!-- Topic details will be inserted here -->
                    </div>
                </div>
                <button onclick="closeChatThread()" 
                  style="background:rgba(255,255,255,0.2); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1.2rem; transition:background 0.3s;">
                  <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chatMessages" style="flex:1; overflow-y:auto; padding:1.5rem;">
            <div id="messagesContainer"></div>
        </div>
        
        <!-- Reply Input -->
        <div style="padding:1rem; border-top:1px solid #eee;">
            <textarea id="chatReplyInput" placeholder="Write your reply..." style="width:100%; padding:0.8rem; border:2px solid #e6e6e6; border-radius:6px; min-height:80px; margin-bottom:0.8rem;"></textarea>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="submitChatReply()" style="background:#1a3c34; color:white; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer;">
                    <i class="fas fa-paper-plane"></i> Post Reply
                </button>
                <button onclick="closeChatThread()" style="background:#666; color:white; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer;">
                    Close Chat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Admin Login -->
<div id="adminLoginOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:12px; width:90%; max-width:400px;">
        <h3 style="color:#1a3c34; margin-top:0;"><i class="fas fa-user-shield"></i> Admin Login</h3>
        <p style="color:#666; margin-bottom:1.5rem;">Enter admin password to access delete options.</p>
        
        <input type="password" id="adminPassword" placeholder="Admin Password" style="width:100%; padding:0.8rem; border:2px solid #e6e6e6; border-radius:6px; margin-bottom:1rem;">
        
        <div style="display:flex; gap:1rem;">
            <button onclick="attemptAdminLogin()" style="flex:1; background:#1a3c34; color:white; border:none; padding:0.8rem; border-radius:6px; cursor:pointer;">
                Login
            </button>
            <button onclick="closeAdminLogin()" style="flex:1; background:#666; color:white; border:none; padding:0.8rem; border-radius:6px; cursor:pointer;">
                Cancel
            </button>
        </div>
        
        <p style="font-size:0.8rem; color:#888; margin-top:1rem; text-align:center;">
            <i class="fas fa-info-circle"></i> Contact system administrator for password
        </p>
    </div>
</div>

<script>
// ... [ALL YOUR PREVIOUS JAVASCRIPT CODE FROM THE LAST MESSAGE GOES HERE] ...

// ================= NEW FUNCTIONS TO ADD =================

// 20. Toggle New Topic Section (Collapse/Expand)
let isNewTopicExpanded = false;

function toggleNewTopicSection() {
    const content = document.getElementById('newTopicContent');
    const arrow = document.getElementById('newTopicArrow');
    const indicator = document.getElementById('newTopicIndicator');
    
    isNewTopicExpanded = !isNewTopicExpanded;
    
    if (isNewTopicExpanded) {
        content.classList.add('expanded');
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-up');
        indicator.textContent = '(Click to collapse)';
        
        // Focus on title input when expanded
        setTimeout(() => {
            document.getElementById('topicTitle').focus();
        }, 300);
    } else {
        content.classList.remove('expanded');
        arrow.classList.remove('fa-chevron-up');
        arrow.classList.add('fa-chevron-down');
        indicator.textContent = '(Click to expand)';
    }
}

// 21. Clear New Topic Form
function clearNewTopicForm() {
    document.getElementById('topicTitle').value = '';
    document.getElementById('topicBody').value = '';
    document.getElementById('topicTitle').focus();
}

// 22. SIMPLIFIED renderTopics() - NO MESSAGE PREVIEWS
function renderTopics(topics) {
  const container = document.getElementById("topicsList");
  const pagination = document.getElementById("pagination");
  
  if (!topics || topics.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="text-align:center; padding:3rem; color:#666;">
        <i class="fas fa-comments" style="font-size:3rem; color:#ccc; margin-bottom:1.5rem;"></i>
        <h3 style="margin:0 0 0.8rem 0; color:#1a3c34;">No Chat Topics Yet</h3>
        <p style="margin:0 0 1.5rem 0; color:#666; max-width:400px; margin:0 auto 1.5rem auto;">
          Start the first conversation! Click "New Chat Topic" above to begin.
        </p>
      </div>
    `;
    pagination.innerHTML = '';
    return;
  }
  
  // Reverse to show newest first
  const sortedTopics = [...topics].reverse();
  
  // Pagination
  const itemsPerPage = 10;
  const page = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;
  const startIndex = (page - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageTopics = sortedTopics.slice(startIndex, endIndex);
  const totalPages = Math.ceil(sortedTopics.length / itemsPerPage);
  
  // Create SIMPLIFIED HTML - NO MESSAGE PREVIEWS
  const topicsHtml = pageTopics.map(topic => {
    const messageCount = topic.messages ? topic.messages.length : 0;
    const lastMessage = topic.messages && topic.messages.length > 0 
      ? topic.messages[topic.messages.length - 1] 
      : null;
    
    // Calculate stats
    let totalLikes = 0;
    let totalReplies = 0;
    if (topic.messages) {
      topic.messages.forEach(msg => {
        totalLikes += msg.likes || 0;
        if (msg.replies) {
          totalReplies += msg.replies.length;
          msg.replies.forEach(reply => {
            totalLikes += reply.likes || 0;
          });
        }
      });
    }
    
    const totalMessages = messageCount + totalReplies;
    const hasRecentActivity = lastMessage ? (new Date() - new Date(lastMessage.date)) < 86400000 : false;
    
    return `
      <div class="topic-item" style="background:#f8f9fa; border-left:4px solid #d4af37; padding:1.5rem; margin-bottom:1rem; border-radius:8px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div style="flex:1;">
            <!-- Topic Title and Stats -->
            <div style="display:flex; align-items:center; gap:1rem; margin-bottom:0.8rem;">
              <h3 style="margin:0; font-size:1.3rem; color:#1a3c34;">
                ${topic.title || 'Untitled Topic'}
              </h3>
              ${hasRecentActivity ? `
                <span style="background:#e8f5e9; color:#2e7d32; padding:0.2rem 0.6rem; border-radius:12px; font-size:0.8rem; font-weight:600;">
                  <i class="fas fa-bolt" style="margin-right:0.3rem;"></i>Active
                </span>
              ` : ''}
            </div>
            
            <!-- Topic Description -->
            ${topic.description ? `
              <p style="color:#555; margin:0 0 1rem 0; font-size:1rem; line-height:1.5;">
                <i class="fas fa-quote-left" style="color:#d4af37; margin-right:0.5rem;"></i>
                ${topic.description}
              </p>
            ` : ''}
            
            <!-- Topic Metadata -->
            <div style="display:flex; flex-wrap:wrap; gap:1.5rem; font-size:0.9rem; color:#666; padding:0.8rem; background:white; border-radius:6px;">
              <span style="display:flex; align-items:center; gap:0.5rem;">
                <i class="fas fa-user" style="color:#1a3c34;"></i>
                <span><strong>Author:</strong> ${topic.user || 'Anonymous'}</span>
              </span>
              
              <span style="display:flex; align-items:center; gap:0.5rem;">
                <i class="fas fa-calendar-alt" style="color:#1a3c34;"></i>
                <span><strong>Created:</strong> ${topic.date ? formatDate(topic.date) : 'No date'}</span>
              </span>
              
              <span style="display:flex; align-items:center; gap:0.5rem;">
                <i class="fas fa-comments" style="color:#d4af37;"></i>
                <span><strong>Messages:</strong> ${totalMessages}</span>
              </span>
              
              <span style="display:flex; align-items:center; gap:0.5rem;">
                <i class="fas fa-fire" style="color:#c62828;"></i>
                <span><strong>Likes:</strong> ${totalLikes}</span>
              </span>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display:flex; flex-direction:column; gap:0.8rem; min-width:140px; margin-left:1.5rem;">
            <!-- View Chat Button -->
            <button onclick="openChatThread('${topic.id}')" 
              style="background:#1a3c34; color:white; border:none; padding:0.8rem 1.2rem; border-radius:6px; cursor:pointer; font-size:1rem; font-weight:600; display:flex; align-items:center; justify-content:center; gap:0.5rem;">
              <i class="fas fa-comments"></i>
              View Chat
            </button>
            
            <!-- Admin Delete Button -->
            ${isAdminMode ? `
              <button onclick="deleteTopic('${topic.id}')" 
                style="background:#c62828; color:white; border:none; padding:0.8rem 1.2rem; border-radius:6px; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:0.5rem;">
                <i class="fas fa-trash-alt"></i>
                Delete
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = topicsHtml;
  
  // Render pagination
  renderPagination(page, totalPages);
}

// 23. Initialize with Header/Footer
window.addEventListener('DOMContentLoaded', () => {
  console.log("Chat Center initialized");
  
  // Load likes from localStorage
  userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
  
  // Add admin button to header
  const adminBtn = document.createElement("button");
  adminBtn.innerHTML = '<i class="fas fa-user-shield"></i> Admin Login';
  adminBtn.className = 'admin-btn';
  adminBtn.style.cssText = "margin-left: 1rem;";
  adminBtn.onclick = showAdminLogin;
  document.getElementById('adminButtonContainer').appendChild(adminBtn);
  
  // Collapse new topic section by default
  document.getElementById('newTopicContent').classList.remove('expanded');
  
  // Load topics
  loadTopics();
});

// 24. Make new functions available globally
window.toggleNewTopicSection = toggleNewTopicSection;
window.clearNewTopicForm = clearNewTopicForm;
</script>
</body>
</html>
