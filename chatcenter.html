<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Center | RaceAnalyst</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Source+Serif+Pro:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            background: #f7f8fa;
            font-family: 'Source Serif Pro', serif;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
        }

        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.7rem;
            font-weight: 600;
        }

        .card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.8rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            color: #1a3c34;
            margin-bottom: 1rem;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 0.6rem;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e6e6e6;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: 'Source Serif Pro';
        }

        button {
            background: #1a3c34;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            color: white;
            font-family: 'Montserrat';
            font-weight: 600;
            cursor: pointer;
        }

        button:hover {
            background: #244e44;
        }

        .topic-item {
            background: #f1f3f5;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }

        .topic-item:hover {
            background: #e6eaed;
        }

        .topic-title {
            font-family: 'Montserrat';
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .topic-meta {
            font-size: 0.9rem;
            color: #666;
        }

        /* Thread view */
        .thread-message {
            background: #eef2f3;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .reply-box {
            margin-top: 1rem;
            padding-left: 15px;
        }

        .reply-thread {
            margin-left: 20px;
            margin-top: 10px;
            border-left: 2px solid #d4af37;
            padding-left: 12px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            margin-right: 12px;
        }

        .action-btn.delete {
            color: #d11a2a;
        }

        .pagination {
            text-align: center;
            margin-top: 1.2rem;
        }

        .pagination button {
            margin: 0 4px;
        }

        .logo-icon {
            font-size: 2rem;
            color: #d4af37;
        }
        /* Footer */
        footer {
            background-color: #1a3c34;
            color: white;
            padding: 3rem 0 1.5rem;
            margin-top: 3rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .footer-section h4 {
            color: #d4af37;
            margin-bottom: 1.2rem;
            font-size: 1.2rem;
        }
        
        .footer-section p {
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-links a {
            color: white;
            background-color: #2d5248;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .social-links a:hover {
            background-color: #d4af37;
            transform: translateY(-3px);
        }
        
        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid #2d5248;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .footer-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ===== HEADER STYLES ===== */
        /* Header */
        header {
            background-color: #1a3c34;
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 2rem;
            color: #d4af37;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            color: white;
            font-weight: 700;
        }
        
        .logo span {
            color: #d4af37;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
            align-items: center;
            margin: 0;
            padding: 0;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        nav a:hover {
            color: #d4af37;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Mobile menu styles */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block !important;
            }
            
            .nav-menu ul {
                display: none;
                flex-direction: column;
                width: 100%;
                text-align: center;
                background: #1a3c34;
                position: absolute;
                top: 100%;
                left: 0;
                padding: 1rem 0;
                z-index: 1000;
                margin: 0;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }
            
            .nav-menu.active ul {
                display: flex !important;
            }
            
            .nav-menu ul li {
                padding: 0.8rem 0;
                width: 100%;
            }
            
            .nav-menu ul li a {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 0.5rem 0;
                width: 100%;
            }
            
            .header-content {
                position: relative;
            }
        }

        .topic-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: #f0f7f4 !important;
        }

        .topic-item button:hover {
            opacity: 0.9;
        }

        #chatOverlay {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .view-icon:hover {
            transform: scale(1.2);
        }
        .topic-row:hover {
            transform: scale(1.01);
            background:#fff;
        }

    </style>
</head>

<body>
<header>
    <div class="container header-content">
        <div class="logo">
            <div class="logo-icon">
                <!-- Horse head icon for RaceAnalyst -->
                <i class="fas fa-horse-head"></i>
            </div>
            <h1>Race<span>Analyst</span></h1>
        </div>

        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>

        <nav class="nav-menu" id="navMenu">
            <ul>
                <!-- Links matching index.html structure - using href="#" with onclick handlers -->
                <li><a href="#" onclick="navigateToHome()"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" onclick="navigateToRaceCalendar()"><i class="fas fa-calendar-alt"></i> Race Calendar</a></li>
                <li><a href="https://raceanalyst.pages.dev/chatcenter" target="_blank"><i class="fas fa-comments"></i> Chat Center</a></li>
                <li><a href="#" onclick="navigateToAnalysis()"><i class="fas fa-chart-bar"></i> Analysis</a></li>
                <li><a href="#" onclick="navigateToUpcomingRaces()"><i class="fas fa-flag-checkered"></i> Upcoming Races</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <!-- Create New Chat Topic -->
    <div class="card">
        <h2 id="newTopicHeader" style="cursor:pointer; display:flex; align-items:center; gap:12px; font-family:'Montserrat'; font-weight:700; font-size:1.35rem; color:#0f2e25; letter-spacing:0.5px;">
            <span id="newTopicToggleIcon" style="font-size:1.4rem; color:#d4af37;">➕</span>
            <span style="background:linear-gradient(90deg,#1a3c34,#4d6f61); -webkit-background-clip:text; background-clip:text; color:transparent;">New Chat Topic</span>
        </h2>

        <div id="newTopicContent" style="display:none;">
            <input type="text" id="userNameInput" placeholder="Your Name" style="margin-bottom:1rem; padding:12px; border:2px solid #e6e6e6; border-radius:6px;">

            <div id="avatarGrid" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:1rem;">
              <img src="https://ui-avatars.com/api/?name=A&background=1a3c34&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=B&background=d4af37&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=C&background=244e44&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=D&background=6a1b9a&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=E&background=c62828&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=F&background=283593&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=G&background=1565c0&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=H&background=2e7d32&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=I&background=ad1457&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=J&background=4e342e&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=K&background=00838f&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              <img src="https://ui-avatars.com/api/?name=L&background=37474f&color=fff&rounded=true" class="avatarOption" style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
            </div>

            <input type="hidden" id="selectedAvatar" value="">
            <input type="text" id="topicTitle" placeholder="Topic Title">
            <textarea id="topicBody" placeholder="Write the first message..." style="min-height:120px;"></textarea>
            <button onclick="createTopic()">
                <i class="fas fa-paper-plane"></i> Create Topic
            </button>
        </div>
    </div>

    <!-- Topics List with Expandable Chats -->
    <div class="card" id="topicsCard">
        <h2 style="font-family:'Montserrat'; font-weight:700; font-size:1.35rem; color:#0f2e25; letter-spacing:0.5px; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-comments" style="color:#d4af37;"></i>
            <span style="background:linear-gradient(90deg,#1a3c34,#4d6f61); -webkit-background-clip:text; background-clip:text; color:transparent;">All Chat Topics</span>
        </h2>
        
        <!-- Admin Toggle (Hidden by default) -->
        <div id="adminPanel" style="display:none; margin-bottom:1rem; padding:1rem; background:#f0f7f4; border-radius:6px;">
            <div style="display:flex; align-items:center; gap:1rem;">
                <i class="fas fa-user-shield" style="color:#1a3c34;"></i>
                <span style="font-weight:600;">Admin Mode Active</span>
                <button onclick="toggleAdminMode(false)" style="margin-left:auto; padding:0.3rem 0.8rem; background:#c62828; color:white; border:none; border-radius:4px; cursor:pointer;">
                    Exit Admin
                </button> 
            </div>
        </div>
        
        <div id="topicsList">Loading topics...</div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Hidden Chat Thread Container (for expanded chats) -->
<div id="chatOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
    <div id="chatContainer" style="background:white; width:90%; max-width:800px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column;">
        <!-- Chat Header -->
        <div style="background:linear-gradient(135deg, #1a3c34 0%, #244e44 100%); color:white; padding:1.2rem; border-radius:12px 12px 0 0;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div style="flex:1;">
                    <div id="chatTopicTitle">
                        <!-- Topic details will be inserted here -->
                    </div>
                </div>
                <button onclick="closeChatThread()" 
                style="background:rgba(255,255,255,0.2); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1.2rem; transition:background 0.3s;">
                <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chatMessages" style="flex:1; overflow-y:auto; padding:1.5rem;">
            <div id="messagesContainer"></div>
        </div>
        
        <!-- Reply Input -->
        <div style="padding:1rem; border-top:1px solid #eee;">
            <input type="text" id="replyUserNameInput" placeholder="Your Name" style="margin-bottom:1rem; padding:12px; border:2px solid #e6e6e6; border-radius:6px;">

            <div id="replyAvatarGrid" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:1rem;">
                <img src="https://ui-avatars.com/api/?name=A&background=1a3c34&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=B&background=d4af37&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=C&background=244e44&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=D&background=6a1b9a&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=E&background=c62828&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=F&background=283593&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=G&background=1565c0&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=H&background=2e7d32&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=I&background=ad1457&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=J&background=4e342e&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=K&background=00838f&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
                
                <img src="https://ui-avatars.com/api/?name=L&background=37474f&color=fff&rounded=true"
                    class="replyAvatarOption"
                    style="width:40px; height:40px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
            </div>

            <input type="hidden" id="replySelectedAvatar" value="">
            <textarea id="chatReplyInput" placeholder="Write your reply..." style="width:100%; padding:0.8rem; border:2px solid #e6e6e6; border-radius:6px; min-height:80px; margin-bottom:0.8rem;"></textarea>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="submitChatReply()" style="background:#1a3c34; color:white; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer;">
                    <i class="fas fa-paper-plane"></i> Post Reply
                </button>
                <button onclick="closeChatThread()" style="background:#666; color:white; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer;">
                    Close Chat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Admin Login -->
<div id="adminLoginOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:12px; width:90%; max-width:400px;">
        <h3 style="color:#1a3c34; margin-top:0;"><i class="fas fa-user-shield"></i> Admin Login</h3>
        <p style="color:#666; margin-bottom:1.5rem;">Enter admin password to access delete options.</p>
        
        <input type="password" id="adminPassword" placeholder="Admin Password" style="width:100%; padding:0.8rem; border:2px solid #e6e6e6; border-radius:6px; margin-bottom:1rem;">
        
        <div style="display:flex; gap:1rem;">
            <button onclick="attemptAdminLogin()" style="flex:1; background:#1a3c34; color:white; border:none; padding:0.8rem; border-radius:6px; cursor:pointer;">
                Login
            </button>
            <button onclick="closeAdminLogin()" style="flex:1; background:#666; color:white; border:none; padding:0.8rem; border-radius:6px; cursor:pointer;">
                Cancel
            </button>
        </div>
        
        <p style="font-size:0.8rem; color:#888; margin-top:1rem; text-align:center;">
            <i class="fas fa-info-circle"></i> Default password: "raceadmin123" (Change in code)
        </p>
    </div>
</div>


<script>
const BASE_URL = "https://broad-sound-fdb7.raceanalyst.workers.dev";
const GET_TOPICS_URL = `${BASE_URL}/chatcenter/get-topics`;
const SAVE_TOPICS_URL = `${BASE_URL}/chatcenter/save-topics`;

// State management
let allTopics = [];
let currentOpenTopic = null;
let isAdminMode = false;
let userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}'); // Track user likes


// ===== REPLY AVATAR SELECTION HANDLER =====
document.addEventListener("DOMContentLoaded", function () {
    const replyAvatarOptions = document.querySelectorAll(".replyAvatarOption");
    const replySelectedAvatarInput = document.getElementById("replySelectedAvatar");

    replyAvatarOptions.forEach(avatar => {
        avatar.addEventListener("click", function () {
            // Remove highlight from all
            replyAvatarOptions.forEach(a => a.style.border = "2px solid transparent");

            // Add highlight to selected
            this.style.border = "2px solid #d4af37";

            // Save selection
            replySelectedAvatarInput.value = this.src;
        });
    });
});

// ===== NESTED REPLY AVATAR SELECTION HANDLER =====
document.addEventListener("click", function (event) {
    if (!event.target.classList.contains("nestedReplyAvatarOption")) return;

    const avatar = event.target;
    const parentId = avatar.getAttribute("data-parent");

    // All avatars in this nested reply box
    const avatars = document.querySelectorAll(
        `.nestedReplyAvatarOption[data-parent="${parentId}"]`
    );

    // Hidden input for this nested reply
    const hiddenInput = document.getElementById(`nestedReplySelectedAvatar-${parentId}`);

    // Clear highlight from all avatars
    avatars.forEach(a => a.style.border = "2px solid transparent");

    // Highlight selected
    avatar.style.border = "2px solid #d4af37";

    // Save selected avatar
    hiddenInput.value = avatar.src;
});

// Helper to get or prompt for user name and cache in localStorage
function getUserName() {
  let userName = localStorage.getItem('chatUserName');
  if (!userName) {
    userName = prompt("Enter your name:", "Anonymous") || "Anonymous";
    localStorage.setItem('chatUserName', userName);
  }
  return userName;
}

// Simple admin password (change this in production!)
const ADMIN_PASSWORD = "raceadmin123";

// ===== NAVIGATION FUNCTIONS =====
function navigateToHome() {
    window.location.href = 'index.html#home';
    return false;
}

function navigateToRaceCalendar() {
    window.location.href = 'index.html#race-calendar';
    return false;
}

function navigateToAnalysis() {
    window.location.href = 'index.html#analysis';
    return false;
}

function navigateToUpcomingRaces() {
    window.location.href = 'index.html#upcoming-races';
    return false;
}

// ===== MOBILE MENU =====
document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const navMenu = document.getElementById('navMenu');
    
    if (mobileMenuBtn && navMenu) {
        mobileMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            navMenu.classList.toggle('active');
            // Change icon based on state
            const icon = mobileMenuBtn.querySelector('i');
            if (navMenu.classList.contains('active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!navMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                navMenu.classList.remove('active');
                const icon = mobileMenuBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            }
        });
        
        // Close menu when clicking a link
        const navLinks = navMenu.querySelectorAll('a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                navMenu.classList.remove('active');
                const icon = mobileMenuBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
        });
    }
});

// ===== CHAT CENTER FUNCTIONS =====
document.getElementById("newTopicHeader").onclick = function() {
    const box = document.getElementById("newTopicContent");
    const icon = document.getElementById("newTopicToggleIcon");

    if (box.style.display === "none") {
        box.style.display = "block";
        icon.textContent = "➖";
    } else {
        box.style.display = "none";
        icon.textContent = "➕";
    }
};

// Utility functions
function isNewTopic(topic) {
    const created = new Date(topic.date);
    const now = new Date();
    const diffHours = (now - created) / (1000 * 60 * 60);
    return diffHours <= 24;
}

function topicHasUnread(topic) {
    return topic.unread === true; // set this field when user has unread messages
}

// 1. Load all chat topics
async function loadTopics() {
  try {
    const topicsList = document.getElementById("topicsList");
    topicsList.innerHTML = '<div class="loading">Loading topics...</div>';
    
    const response = await fetch(GET_TOPICS_URL);
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    let topics = await response.json();
    
    // Ensure topics is an array
    if (!Array.isArray(topics)) {
      if (topics && Array.isArray(topics.topics)) {
        topics = topics.topics;
      } else if (topics && typeof topics === 'object') {
        topics = Object.values(topics);
      } else {
        topics = [];
      }
    }
    
    allTopics = topics;
    renderTopics(topics);
    
  } catch (error) {
    console.error("Failed to load topics:", error);
    const topicsList = document.getElementById("topicsList");
    topicsList.innerHTML = `
      <div class="error" style="background:#ffe6e6; padding:1rem; border-radius:6px;">
        <h3 style="color:#c62828; margin-top:0;">Error Loading Topics</h3>
        <p>${error.message}</p>
        <button onclick="loadTopics()" style="margin-top:0.5rem;">Retry</button>
      </div>
    `;
  }
}

// 2. Render topics list
function renderTopics(topics) {
  const container = document.getElementById("topicsList");
  const pagination = document.getElementById("pagination");
  
  if (!topics || topics.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="text-align:center; padding:2rem; color:#666;">
        <i class="fas fa-comments" style="font-size:2.5rem; color:#ccc; margin-bottom:1rem;"></i>
        <h3 style="margin:0 0 0.5rem 0;">No Chat Topics Yet</h3>
        <p style="margin:0 0 1rem 0;">Be the first to start a conversation!</p>
      </div>
    `;
    pagination.innerHTML = '';
    return;
  }
  
  // Reverse to show newest first
  const sortedTopics = [...topics].reverse();
  
  // Simple pagination
  const itemsPerPage = 10;
  const page = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;
  const startIndex = (page - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageTopics = sortedTopics.slice(startIndex, endIndex);
  const totalPages = Math.ceil(sortedTopics.length / itemsPerPage);
  
  const topicsHtml = pageTopics.map(topic => {
    const messageCount = topic.messages ? topic.messages.length : 0;
    const lastMessage = topic.messages && topic.messages.length > 0 
      ? topic.messages[topic.messages.length - 1] 
      : null;
    
    // Calculate total likes for this topic
    let totalLikes = 0;
    let totalReplies = 0;
    if (topic.messages) {
      topic.messages.forEach(msg => {
        totalLikes += msg.likes || 0;
        if (msg.replies) {
          totalReplies += msg.replies.length;
          msg.replies.forEach(reply => {
            totalLikes += reply.likes || 0;
          });
        }
      });
    }
    
    return `
    <div class="topic-item topic-row" onclick="openChatThread('${topic.id}')" 
        style="background:#f8f9fa; border-left:4px solid #d4af37; padding:1.2rem; margin-bottom:1rem; border-radius:6px; cursor:pointer; transition:0.2s;">
        
        <div style="display:flex; justify-content:space-between; align-items:center;">

            <div style="display:flex; align-items:center; gap:0.5rem;">
                <i class="fas fa-comment-dots" style="color:#d4af37;"></i>

                <h3 style="margin:0; color:#1a3c34; font-size:1.15rem;">
                    ${topic.title}
                </h3>

                ${isNewTopic(topic) ? `
                    <span style="background:red; color:white; padding:2px 6px; border-radius:4px; font-size:0.7rem;">NEW</span>
                ` : ""}
                
                ${topicHasUnread(topic) ? `
                    <span style="width:9px; height:9px; background:green; border-radius:50%; display:inline-block;"></span>
                ` : ""}
            </div>

            <!-- Eye Button -->
            <button onclick="openChatThread('${topic.id}'); event.stopPropagation();"
                style="display:flex; align-items:center; gap:5px; background:none; border:none; cursor:pointer; color:#1a3c34; font-size:0.95rem; padding:6px; transition:0.2s;">
                
                <i class="fas fa-eye view-icon" style="font-size:1.1rem;"></i>
                <span style="font-size:0.85rem;">View</span>
            </button>
        </div>

        <div style="font-size:0.9rem; color:#444; display:flex; gap:1.5rem; flex-wrap:wrap; margin-top:6px;">
            <span><i class="fas fa-user"></i> ${topic.user || "Anonymous"}</span>
            <span><i class="fas fa-calendar"></i> ${formatDate(topic.date)}</span>
            <span><i class="fas fa-comments" style="color:#25D366;"></i> ${messageCount} message${messageCount !== 1 ? 's' : ''}</span>
            <span><i class="fas fa-heart" style="color:#e91e63;"></i> ${totalLikes} like${totalLikes !== 1 ? 's' : ''}</span>
            <span><i class="fas fa-clock"></i> Last activity: ${lastMessage ? formatDate(lastMessage.date) : formatDate(topic.date)}</span>
        </div>
    </div>
    `;
  }).join('');
  
  container.innerHTML = topicsHtml;
  
  // Render pagination
  renderPagination(page, totalPages);
}

// 3. Pagination helper
function renderPagination(currentPage, totalPages) {
  const pagination = document.getElementById("pagination");
  
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let paginationHtml = '<div style="display:flex; gap:0.5rem; justify-content:center; margin-top:2rem;">';
  
  if (currentPage > 1) {
    paginationHtml += `
      <button onclick="goToPage(${currentPage - 1})" style="padding:0.5rem 1rem; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer;">
        <i class="fas fa-chevron-left"></i> Previous
      </button>
    `;
  }
  
  // Show first page, current page, and last page
  const pagesToShow = [1];
  if (currentPage > 3) pagesToShow.push('...');
  for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
    pagesToShow.push(i);
  }
  if (currentPage < totalPages - 2) pagesToShow.push('...');
  if (totalPages > 1) pagesToShow.push(totalPages);
  
  pagesToShow.forEach(pageNum => {
    if (pageNum === '...') {
      paginationHtml += `<span style="padding:0.5rem 1rem;">...</span>`;
    } else if (pageNum === currentPage) {
      paginationHtml += `
        <button style="padding:0.5rem 1rem; border:none; background:#1a3c34; color:white; border-radius:4px;">
          ${pageNum}
        </button>
      `;
    } else {
      paginationHtml += `
        <button onclick="goToPage(${pageNum})" style="padding:0.5rem 1rem; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer;">
          ${pageNum}
        </button>
      `;
    }
  });
  
  if (currentPage < totalPages) {
    paginationHtml += `
      <button onclick="goToPage(${currentPage + 1})" style="padding:0.5rem 1rem; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer;">
        Next <i class="fas fa-chevron-right"></i>
      </button>
    `;
  }
  
  paginationHtml += '</div>';
  pagination.innerHTML = paginationHtml;
}

// 4. Open chat thread in overlay
function openChatThread(topicId) {
  const topic = allTopics.find(t => t.id === topicId);
  if (!topic) return;
  
  currentOpenTopic = topic;
  
  // Calculate stats for this topic
  let totalLikes = 0;
  let totalReplies = 0;
  if (topic.messages) {
    topic.messages.forEach(msg => {
      totalLikes += msg.likes || 0;
      if (msg.replies) {
        totalReplies += msg.replies.length;
        msg.replies.forEach(reply => {
          totalLikes += reply.likes || 0;
        });
      }
    });
  }
  
  const totalMessages = (topic.messages ? topic.messages.length : 0) + totalReplies;
  
  // Update chat header with topic details
  const headerHtml = `
    <div>
      <h3 style="margin:0 0 0.3rem 0; color:white; font-size:1.3rem;">
        <i class="fas fa-comment-dots" style="margin-right:0.5rem;"></i>
        ${topic.title || 'Chat Topic'}
      </h3>
      <div style="display:flex; gap:1rem; font-size:0.85rem; opacity:0.9;">
        <span><i class="fas fa-user"></i> ${topic.user || 'Anonymous'}</span>
        <span><i class="fas fa-calendar"></i> ${topic.date ? formatDate(topic.date) : ''}</span>
        <span><i class="fas fa-comments" style="color:#25D366;"></i> ${totalMessages} messages</span>
        <span><i class="fas fa-fire"></i> ${totalLikes} likes</span>
      </div>
      ${topic.description ? `
        <div style="margin-top:0.5rem; padding:0.5rem; background:rgba(255,255,255,0.1); border-radius:4px; font-size:0.9rem;">
          <i class="fas fa-info-circle" style="margin-right:0.3rem;"></i>
          ${topic.description}
        </div>
      ` : ''}
    </div>
  `;
  
  document.getElementById("chatTopicTitle").innerHTML = headerHtml;
  document.getElementById("chatMessages").scrollTop = 0;
  
  // Render messages
  renderChatMessages(topic.messages || []);
  
  // Show overlay
  document.getElementById("chatOverlay").style.display = "flex";
  document.body.style.overflow = "hidden";
  
  // Focus on reply input
  setTimeout(() => {
    document.getElementById("chatReplyInput").focus();
  }, 300);
}

// 5. Render chat messages
function renderChatMessages(messages) {
  const container = document.getElementById("messagesContainer");
  
  if (!messages || messages.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:3rem; color:#666;">
        <i class="fas fa-comment-slash" style="font-size:2.5rem; color:#ccc; margin-bottom:1rem;"></i>
        <h3 style="margin:0 0 0.5rem 0;">No Messages Yet</h3>
        <p>Be the first to post a message!</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = messages.map(msg => renderChatMessage(msg, 0)).join('');
}

// 6. Render single chat message with avatars and user names
function renderChatMessage(msg, depth = 0) {
  const messageId = msg.id;
  const userLiked = userLikes[messageId] === true;
  const canLike = !userLiked;

  const avatar = msg.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.user || 'A')}&background=1a3c34&color=fff&rounded=true`;

  return `
    <div class="chat-message" style="margin-left:${depth * 20}px; margin-bottom:1rem;">
      <div style="background:${depth === 0 ? '#f0f7f4' : '#f8f9fa'}; border-radius:8px; padding:1rem;">
        <div style="display:flex; align-items:flex-start; gap:10px; margin-bottom:0.5rem;">
          <img src="${avatar}" alt="avatar" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
          <div style="flex:1;">
            <div style="font-weight:600; color:#1a3c34;">${msg.user || 'Anonymous'}</div>
            <div style="font-size:0.8rem; color:#888;">${formatDate(msg.date)}</div>
          </div>
        </div>
        <div style="color:#333; margin-bottom:0.8rem; padding-left:46px;">${msg.text}</div>
        <div style="display:flex; gap:1rem; align-items:center; padding-left:46px;">
          <button onclick="${canLike ? `likeChatMessage('${messageId}')` : ''}" 
            ${!canLike ? 'disabled' : ''}
            style="background:none; border:none; color:${userLiked ? '#e91e63' : '#666'}; cursor:${canLike ? 'pointer' : 'not-allowed'}; padding:0.3rem 0.6rem; border-radius:4px; font-size:0.9rem;">
            <i class="fas fa-heart" style="color:#e91e63;"></i>
            ${msg.likes || 0} Like${msg.likes !== 1 ? 's' : ''}
            ${userLiked ? ' (You liked)' : ''}
          </button>
          <button onclick="showChatReplyBox('${messageId}')" 
            style="background:none; border:none; color:#666; cursor:pointer; padding:0.3rem 0.6rem; border-radius:4px; font-size:0.9rem;">
            <i class="fas fa-reply"></i> Reply
          </button>
        </div>
        <div id="chatReplyBox-${messageId}" style="display:none; margin-top:1rem; padding-left:46px;">
          <input type="text" id="nestedReplyUserNameInput-${messageId}" placeholder="Your Name" 
                 style="margin-bottom:0.6rem; padding:10px; border:1px solid #ddd; border-radius:4px; width:100%;">

          <div id="nestedReplyAvatarGrid-${messageId}" 
               style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:0.6rem;">
              <img src="https://ui-avatars.com/api/?name=A&background=1a3c34&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              
              <img src="https://ui-avatars.com/api/?name=B&background=d4af37&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              
              <img src="https://ui-avatars.com/api/?name=C&background=244e44&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              
              <img src="https://ui-avatars.com/api/?name=D&background=6a1b9a&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
              
              <img src="https://ui-avatars.com/api/?name=E&background=c62828&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">

              <img src="https://ui-avatars.com/api/?name=F&background=283593&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">

              <img src="https://ui-avatars.com/api/?name=G&background=1565c0&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">

              <img src="https://ui-avatars.com/api/?name=H&background=2e7d32&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">

              <img src="https://ui-avatars.com/api/?name=I&background=ad1457&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">

              <img src="https://ui-avatars.com/api/?name=J&background=4e342e&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">

              <img src="https://ui-avatars.com/api/?name=K&background=00838f&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">

              <img src="https://ui-avatars.com/api/?name=L&background=37474f&color=fff&rounded=true"
                  class="nestedReplyAvatarOption" data-parent="${messageId}"
                  style="width:32px; height:32px; border-radius:50%; cursor:pointer; border:2px solid transparent;">
          </div>

          <input type="hidden" id="nestedReplySelectedAvatar-${messageId}" value="">
          <textarea id="chatReplyInput-${messageId}" placeholder="Write your reply..." style="width:100%; padding:0.6rem; border:1px solid #ddd; border-radius:4px; min-height:60px; margin-bottom:0.5rem;"></textarea>
          <div>
            <button onclick="submitChatNestedReply('${messageId}')" style="background:#1a3c34; color:white; border:none; padding:0.4rem 0.8rem; border-radius:4px; cursor:pointer; font-size:0.85rem;">
              Post Reply
            </button>
            <button onclick="hideChatReplyBox('${messageId}')" style="background:#666; color:white; border:none; padding:0.4rem 0.8rem; border-radius:4px; cursor:pointer; margin-left:0.5rem; font-size:0.85rem;">
              Cancel
            </button>
          </div>
        </div>
        <div style="margin-top:1rem;">
          ${(msg.replies || []).map(reply => renderChatMessage(reply, depth + 1)).join('')}
        </div>
      </div>
    </div>
  `;
}

// 7. Like a chat message (with one-like restriction)
async function likeChatMessage(messageId) {
  if (userLikes[messageId]) {
    alert("You have already liked this message!");
    return;
  }
  
  const topic = currentOpenTopic;
  if (!topic || !topic.messages) return;
  
  // Find and update the message
  function updateMessageLikes(messages) {
    for (let msg of messages) {
      if (msg.id === messageId) {
        msg.likes = (msg.likes || 0) + 1;
        return true;
      }
      if (msg.replies) {
        if (updateMessageLikes(msg.replies)) return true;
      }
    }
    return false;
  }
  
  if (updateMessageLikes(topic.messages)) {
    // Record user's like
    userLikes[messageId] = true;
    localStorage.setItem('userLikes', JSON.stringify(userLikes));
    
    // Update the topic in allTopics
    const topicIndex = allTopics.findIndex(t => t.id === topic.id);
    if (topicIndex !== -1) {
      allTopics[topicIndex] = topic;
    }
    
    // Save to server
    await saveTopicsToServer();
    
    // Re-render messages
    renderChatMessages(topic.messages);
  }
}

// 8. Show/hide reply box in chat
function showChatReplyBox(messageId) {
  document.getElementById(`chatReplyBox-${messageId}`).style.display = 'block';
  document.getElementById(`chatReplyInput-${messageId}`).focus();
}

function hideChatReplyBox(messageId) {
  document.getElementById(`chatReplyBox-${messageId}`).style.display = 'none';
  document.getElementById(`chatReplyInput-${messageId}`).value = '';
}

// 9. Submit nested reply in chat (with user name and avatar)
// 9. Submit nested reply in chat (with user name and avatar)
// 9. Submit nested reply in chat (with user name and avatar)
async function submitChatNestedReply(parentId) {
    const input = document.getElementById(`chatReplyInput-${parentId}`);
    const text = input.value.trim();

    if (!text) {
        alert("Please enter a reply");
        return;
    }

    // Get name + avatar from NESTED reply inputs
    const userInput = document.getElementById(`nestedReplyUserNameInput-${parentId}`);
    const avatarInput = document.getElementById(`nestedReplySelectedAvatar-${parentId}`);

    const user = (userInput?.value.trim()) || "Anonymous";
    const avatarSelected = (avatarInput?.value.trim()) || "";

    // Avatar fallback (initial-letter avatar)
    const avatar = avatarSelected ||
        `https://ui-avatars.com/api/?name=${encodeURIComponent(user)}&background=1a3c34&color=fff&rounded=true`;

    const topic = currentOpenTopic;
    if (!topic) return;

    // Helper to add nested reply to correct message
    function addReplyToMessage(messages, parentId, newReply) {
        for (let msg of messages) {
            if (msg.id === parentId) {
                if (!msg.replies) msg.replies = [];
                msg.replies.push(newReply);
                return true;
            }
            if (msg.replies) {
                if (addReplyToMessage(msg.replies, parentId, newReply)) return true;
            }
        }
        return false;
    }

    const newReply = {
        id: Date.now().toString(),
        user: user,
        avatar: avatar,
        text: text,
        date: new Date().toLocaleString(),
        likes: 0,
        replies: []
    };

    if (addReplyToMessage(topic.messages, parentId, newReply)) {
        // Update topic in allTopics
        const topicIndex = allTopics.findIndex(t => t.id === topic.id);
        if (topicIndex !== -1) {
            allTopics[topicIndex] = topic;
        }

        // Save to server
        await saveTopicsToServer();

        // Clear nested reply inputs
        input.value = "";
        if (userInput) userInput.value = "";
        if (avatarInput) avatarInput.value = "";

        // Clear avatar highlights for this nested box
        const nestedAvatars = document.querySelectorAll(
            `.nestedReplyAvatarOption[data-parent="${parentId}"]`
        );
        nestedAvatars.forEach(a => a.style.border = "2px solid transparent");

        // Hide reply box
        hideChatReplyBox(parentId);

        // Re-render messages
        renderChatMessages(topic.messages);
    }
}

// 10. Submit main reply in chat (with user name and avatar)
// 10. Submit main reply in chat (with user name and avatar)
async function submitChatReply() {
  const input = document.getElementById("chatReplyInput");
  const text = input.value.trim();

  const userInput = document.getElementById("replyUserNameInput");
  const avatarInput = document.getElementById("replySelectedAvatar");

  const user = userInput.value.trim() || "Anonymous";
  const avatar = avatarInput.value.trim() ||
      `https://ui-avatars.com/api/?name=${encodeURIComponent(user)}&background=1a3c34&color=fff&rounded=true`;

  if (!text) {
    alert("Please enter a reply");
    return;
  }

  const topic = currentOpenTopic;
  if (!topic) return;

  if (!topic.messages) topic.messages = [];

  const newMessage = {
    id: Date.now().toString(),
    user: user,
    avatar: avatar,
    text: text,
    date: new Date().toLocaleString(),
    likes: 0,
    replies: []
  };

  topic.messages.push(newMessage);

  // Update allTopics
  const topicIndex = allTopics.findIndex(t => t.id === topic.id);
  if (topicIndex !== -1) {
    allTopics[topicIndex] = topic;
  }

  // Save to server
  await saveTopicsToServer();

  // Clear inputs
  input.value = "";
  // Optional: keep name for next reply
  // userInput.value = "";
  avatarInput.value = "";

  // Remove highlight from avatars
  document.querySelectorAll(".replyAvatarOption").forEach(a => {
    a.style.border = "2px solid transparent";
  });

  // Re-render messages
  renderChatMessages(topic.messages);

  // Scroll to bottom
  setTimeout(() => {
    const chatBox = document.getElementById("chatMessages");
    chatBox.scrollTop = chatBox.scrollHeight;
  }, 100);
}

// 11. Close chat thread
function closeChatThread() {
  document.getElementById("chatOverlay").style.display = "none";
  document.body.style.overflow = "auto";
  currentOpenTopic = null;
  
  // Reload topics to reflect any changes
  loadTopics();
}

// 12. Admin functionality
function showAdminLogin() {
  document.getElementById("adminLoginOverlay").style.display = "flex";
  document.getElementById("adminPassword").focus();
}

function closeAdminLogin() {
  document.getElementById("adminLoginOverlay").style.display = "none";
  document.getElementById("adminPassword").value = "";
}

function attemptAdminLogin() {
  const password = document.getElementById("adminPassword").value;
  
  if (password === ADMIN_PASSWORD) {
    localStorage.setItem("isAdmin", "true");
    document.getElementById("adminPanel").style.display = "block";
    closeAdminLogin();
    loadTopics(); // Re-render with delete buttons
    alert("Admin mode activated");
  } else {
    alert("Incorrect password");
    document.getElementById("adminPassword").value = "";
    document.getElementById("adminPassword").focus();
  }
}

function toggleAdminMode(enable) {
  isAdminMode = enable;
  document.getElementById("adminPanel").style.display = enable ? "block" : "none";
  loadTopics(); // Re-render with/without delete buttons
}

// 13. Save topics to server
async function saveTopicsToServer() {
  try {
    const response = await fetch(SAVE_TOPICS_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(allTopics)
    });
    
    if (!response.ok) {
      throw new Error(`Save failed: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error("Failed to save topics:", error);
    alert("Failed to save changes. Please try again.");
    throw error;
  }
}

// 14. Create topic function
// Create a new topic (with user + avatar)
async function createTopic() {
    const titleInput = document.getElementById("newTopicTitle");
    const title = titleInput.value.trim();
    const contentInput = document.getElementById("newTopicContentInput");
    const content = contentInput.value.trim();

    const userInput = document.getElementById("newTopicUserNameInput");
    const avatarInput = document.getElementById("newTopicSelectedAvatar");

    const user = (userInput?.value.trim()) || "Anonymous";
    const avatarSelected = (avatarInput?.value.trim()) || "";

    // Avatar fallback (auto-generated from user name)
    const avatar = avatarSelected ||
        `https://ui-avatars.com/api/?name=${encodeURIComponent(user)}&background=1a3c34&color=fff&rounded=true`;

    if (!title) {
        alert("Please enter a topic title");
        return;
    }

    if (!content) {
        alert("Please enter some content");
        return;
    }

    // New topic object
    const newTopic = {
        id: Date.now().toString(),
        title: title,
        content: content,
        user: user,
        avatar: avatar,
        date: new Date().toLocaleString(),
        likes: 0,
        messages: []
    };

    // Add to allTopics
    allTopics.unshift(newTopic);

    // Save to server
    await saveTopicsToServer();

    // Clear input fields
    titleInput.value = "";
    contentInput.value = "";
    if (userInput) userInput.value = "";
    if (avatarInput) avatarInput.value = "";

    // Clear avatar grid highlight
    document.querySelectorAll(".avatarOption").forEach(a => {
        a.style.border = "2px solid transparent";
    });

    closeNewTopic();  // Hide modal
    renderTopics();   // Refresh topic list
}

// 15. Delete topic (admin only)
async function deleteTopic(topicId) {
  if (!isAdminMode) {
    showAdminLogin();
    return;
  }
  
  if (!confirm("Delete this topic and all messages?")) return;
  
  try {
    allTopics = allTopics.filter(topic => topic.id !== topicId);
    
    await saveTopicsToServer();
    
    // If this topic is open, close it
    if (currentOpenTopic && currentOpenTopic.id === topicId) {
      closeChatThread();
    }
    
    alert("Topic deleted");
    loadTopics();
  } catch (error) {
    alert("Failed to delete: " + error.message);
  }
}

// 16. Helper functions
function formatDate(dateString) {
  if (!dateString) return 'Unknown';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
  } catch {
    return dateString;
  }
}

function goToPage(pageNumber) {
  const url = new URL(window.location);
  url.searchParams.set('page', pageNumber);
  window.location.href = url.toString();
}

// 17. Initialize
window.addEventListener('DOMContentLoaded', () => {
  console.log("Chat Center initialized");
  
  // Load likes from localStorage
  userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
  
  // Add admin button to header
  const header = document.querySelector(".container .page-title") || document.querySelector("header .container");
  if (header) {
    const adminBtn = document.createElement("button");
    adminBtn.innerHTML = '<i class="fas fa-user-shield"></i> Admin';
    adminBtn.style.cssText = "background:#d4af37; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer; margin-left:1rem;";
    adminBtn.onclick = showAdminLogin;
    if (localStorage.getItem("isAdmin") === "true") {
      header.appendChild(adminBtn);
    }
  }
  
  // Load topics
  loadTopics();
});

// 18. Global functions
window.loadTopics = loadTopics;
window.createTopic = createTopic;
window.deleteTopic = deleteTopic;
window.openChatThread = openChatThread;
window.closeChatThread = closeChatThread;
window.likeChatMessage = likeChatMessage;
window.submitChatReply = submitChatReply;
window.submitChatNestedReply = submitChatNestedReply;
window.showChatReplyBox = showChatReplyBox;
window.hideChatReplyBox = hideChatReplyBox;
window.showAdminLogin = showAdminLogin;
window.closeAdminLogin = closeAdminLogin;
window.attemptAdminLogin = attemptAdminLogin;
window.toggleAdminMode = toggleAdminMode;
window.goToPage = goToPage;

// Navigation functions
window.navigateToHome = navigateToHome;
window.navigateToRaceCalendar = navigateToRaceCalendar;
window.navigateToAnalysis = navigateToAnalysis;
window.navigateToUpcomingRaces = navigateToUpcomingRaces;
</script>

</footer>
    <footer>
        <div class="container footer-content">
            <div class="footer-section">
                <h4>About RaceAnalyst</h4>
                <p>Your trusted platform for racing analytics, statistics, and insights.</p>
            </div>

            <div class="footer-section">
                <h4>Quick Links</h4>
                <p><a href="#" onclick="navigateToHome()" style="color:#ccc; text-decoration:none;">Home</a></p>
                <p><a href="#" onclick="navigateToAnalysis()" style="color:#ccc; text-decoration:none;">Analysis</a></p>
                <p><a href="https://raceanalyst.pages.dev/chatcenter" target="_blank" style="color:#ccc; text-decoration:none;">Chat Center</a></p>
            </div>

            <div class="footer-section">
                <h4>Follow Us</h4>
                <div class="social-links">
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>

        <div class="copyright">
            © 2025 RaceAnalyst. All rights reserved.
        </div>
    </footer>
</body>
</html>
