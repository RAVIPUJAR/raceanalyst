<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Center | RaceAnalyst</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Source+Serif+Pro:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            background: #f7f8fa;
            font-family: 'Source Serif Pro', serif;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
        }

        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.7rem;
            font-weight: 600;
        }

        .card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.8rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            color: #1a3c34;
            margin-bottom: 1rem;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 0.6rem;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e6e6e6;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: 'Source Serif Pro';
        }

        button {
            background: #1a3c34;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            color: white;
            font-family: 'Montserrat';
            font-weight: 600;
            cursor: pointer;
        }

        button:hover {
            background: #244e44;
        }

        .topic-item {
            background: #f1f3f5;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }

        .topic-item:hover {
            background: #e6eaed;
        }

        .topic-title {
            font-family: 'Montserrat';
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .topic-meta {
            font-size: 0.9rem;
            color: #666;
        }

        /* Thread view */
        .thread-message {
            background: #eef2f3;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .reply-box {
            margin-top: 1rem;
            padding-left: 15px;
        }

        .reply-thread {
            margin-left: 20px;
            margin-top: 10px;
            border-left: 2px solid #d4af37;
            padding-left: 12px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            margin-right: 12px;
        }

        .action-btn.delete {
            color: #d11a2a;
        }

        .pagination {
            text-align: center;
            margin-top: 1.2rem;
        }

        .pagination button {
            margin: 0 4px;
        }

        .logo-icon {
            font-size: 2rem;
            color: #d4af37;
        }
        /* Footer */
        footer {
            background-color: #1a3c34;
            color: white;
            padding: 3rem 0 1.5rem;
            margin-top: 3rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .footer-section h4 {
            color: #d4af37;
            margin-bottom: 1.2rem;
            font-size: 1.2rem;
        }
        
        .footer-section p {
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-links a {
            color: white;
            background-color: #2d5248;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .social-links a:hover {
            background-color: #d4af37;
            transform: translateY(-3px);
        }
        
        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid #2d5248;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .footer-content {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Removed .analysis-display { min-height: auto; } */
            .admin-form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* ===== HEADER STYLES ===== */
        /* Header */
        header {
            background-color: #1a3c34;
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 2rem;
            color: #d4af37;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            color: white;
            font-weight: 700;
        }
        
        .logo span {
            color: #d4af37;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
            align-items: center;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        nav a:hover {
            color: #d4af37;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }


        /* Mobile menu styles - ADD THIS */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block !important;
            }
            
            .nav-menu ul {
                display: none;
                flex-direction: column;
                width: 100%;
                text-align: center;
                background: #1a3c34;
                position: absolute;
                top: 100%;
                left: 0;
                padding: 1rem 0;
                z-index: 1000;
            }
            
            .nav-menu.active ul {
                display: flex !important;
            }
            
            .nav-menu ul li {
                padding: 0.8rem 0;
            }
        }
    </style>
</head>

<body>



<div class="container">

    <!-- Create New Chat Topic -->
    <div class="card">
        <h2><i class="fas fa-plus-circle"></i> New Chat Topic</h2>

        <input type="text" id="topicTitle" placeholder="Topic Title (e.g., 'Mumbai Race - Final Thoughts')">

        <textarea id="topicBody" placeholder="Write the first message for this topic..." style="min-height:120px;"></textarea>

        <button onclick="createTopic()">
            <i class="fas fa-paper-plane"></i> Create Topic
        </button>
    </div>

    <!-- Topics List -->
    <div class="card" id="topicsCard">
        <h2><i class="fas fa-comments"></i> All Chat Topics</h2>
        <div id="topicsList">Loading topics...</div>
        <div class="pagination" id="pagination"></div>
    </div>

</div>


// Update this in your chatcenter.html file
<script>
const BASE_URL = "https://broad-sound-fdb7.raceanalyst.workers.dev";
const GET_TOPICS_URL = `${BASE_URL}/chatcenter/get-topics`;
const SAVE_TOPICS_URL = `${BASE_URL}/chatcenter/save-topics`;

// 1. Load all chat topics
async function loadTopics() {
  try {
    console.log("Fetching topics from:", GET_TOPICS_URL);
    const topicsList = document.getElementById("topicsList");
    topicsList.innerHTML = '<div class="loading">Loading topics...</div>';
    
    const response = await fetch(GET_TOPICS_URL);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    let topics = await response.json();
    console.log("Raw API response:", topics);
    
    // Ensure topics is an array
    if (!Array.isArray(topics)) {
      console.warn("API returned non-array, converting...");
      if (topics && Array.isArray(topics.topics)) {
        topics = topics.topics;
      } else if (topics && typeof topics === 'object') {
        topics = Object.values(topics);
      } else {
        topics = [];
      }
    }
    
    console.log("Topics loaded:", topics.length);
    renderTopics(topics);
    
  } catch (error) {
    console.error("Failed to load topics:", error);
    const topicsList = document.getElementById("topicsList");
    topicsList.innerHTML = `
      <div class="error" style="background:#ffe6e6; padding:1rem; border-radius:6px;">
        <h3 style="color:#c62828; margin-top:0;">Error Loading Topics</h3>
        <p>${error.message}</p>
        <button onclick="loadTopics()" style="margin-top:0.5rem;">Retry</button>
      </div>
    `;
  }
}

// 2. Render topics list
function renderTopics(topics) {
  const container = document.getElementById("topicsList");
  const pagination = document.getElementById("pagination");
  
  if (!topics || topics.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="text-align:center; padding:2rem; color:#666;">
        <i class="fas fa-comments" style="font-size:2.5rem; color:#ccc; margin-bottom:1rem;"></i>
        <h3 style="margin:0 0 0.5rem 0;">No Chat Topics Yet</h3>
        <p style="margin:0 0 1rem 0;">Be the first to start a conversation!</p>
      </div>
    `;
    pagination.innerHTML = '';
    return;
  }
  
  // Reverse to show newest first
  const sortedTopics = [...topics].reverse();
  
  // Simple pagination - show 10 per page
  const itemsPerPage = 10;
  const page = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;
  const startIndex = (page - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageTopics = sortedTopics.slice(startIndex, endIndex);
  const totalPages = Math.ceil(sortedTopics.length / itemsPerPage);
  
  // Create HTML for each topic
  const topicsHtml = pageTopics.map(topic => {
    const messageCount = topic.messages ? topic.messages.length : 0;
    const lastMessage = topic.messages && topic.messages.length > 0 
      ? topic.messages[topic.messages.length - 1] 
      : null;
    
    return `
      <div class="topic-item" style="background:#f8f9fa; border-left:4px solid #d4af37; padding:1rem; margin-bottom:1rem; border-radius:4px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div style="flex:1;">
            <h3 style="margin:0 0 0.5rem 0; font-size:1.1rem;">
              <a href="chatcenter_thread?topic=${topic.id}" style="color:#1a3c34; text-decoration:none; font-weight:600;">
                <i class="fas fa-comment-dots" style="color:#d4af37; margin-right:0.5rem;"></i>
                ${topic.title || 'Untitled Topic'}
              </a>
            </h3>
            
            ${topic.description ? `
              <p style="color:#555; margin:0 0 0.5rem 0; font-size:0.9rem;">
                ${topic.description}
              </p>
            ` : ''}
            
            <div style="display:flex; flex-wrap:wrap; gap:1rem; font-size:0.85rem; color:#666;">
              <span><i class="fas fa-user" style="margin-right:0.3rem;"></i> ${topic.user || 'Anonymous'}</span>
              <span><i class="fas fa-calendar" style="margin-right:0.3rem;"></i> ${topic.date || 'No date'}</span>
              <span><i class="fas fa-comment" style="margin-right:0.3rem;"></i> ${messageCount} message${messageCount !== 1 ? 's' : ''}</span>
              
              ${lastMessage ? `
                <span><i class="fas fa-clock" style="margin-right:0.3rem;"></i> Last reply: ${lastMessage.date || 'Recently'}</span>
              ` : ''}
            </div>
          </div>
          
          <div style="display:flex; gap:0.5rem;">
            <button onclick="deleteTopic('${topic.id}')" class="delete-btn" 
              style="background:#c62828; color:white; border:none; padding:0.4rem 0.8rem; border-radius:4px; cursor:pointer; font-size:0.85rem;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = topicsHtml;
  
  // Render pagination
  if (totalPages > 1) {
    let paginationHtml = '<div style="display:flex; gap:0.5rem; justify-content:center; margin-top:2rem;">';
    
    if (page > 1) {
      paginationHtml += `
        <button onclick="goToPage(${page - 1})" style="padding:0.5rem 1rem; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer;">
          <i class="fas fa-chevron-left"></i> Previous
        </button>
      `;
    }
    
    for (let i = 1; i <= totalPages; i++) {
      if (i === page) {
        paginationHtml += `
          <button style="padding:0.5rem 1rem; border:none; background:#1a3c34; color:white; border-radius:4px;">
            ${i}
          </button>
        `;
      } else {
        paginationHtml += `
          <button onclick="goToPage(${i})" style="padding:0.5rem 1rem; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer;">
            ${i}
          </button>
        `;
      }
    }
    
    if (page < totalPages) {
      paginationHtml += `
        <button onclick="goToPage(${page + 1})" style="padding:0.5rem 1rem; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer;">
          Next <i class="fas fa-chevron-right"></i>
        </button>
      `;
    }
    
    paginationHtml += '</div>';
    pagination.innerHTML = paginationHtml;
  } else {
    pagination.innerHTML = '';
  }
}

// 3. CREATE TOPIC FUNCTION (This was missing!)
async function createTopic() {
  const titleInput = document.getElementById("topicTitle");
  const bodyInput = document.getElementById("topicBody");
  
  const title = titleInput.value.trim();
  const body = bodyInput.value.trim();
  
  if (!title) {
    alert("Please enter a topic title");
    titleInput.focus();
    return;
  }
  
  if (!body) {
    alert("Please enter the first message for this topic");
    bodyInput.focus();
    return;
  }
  
  try {
    // Show loading state
    const createBtn = document.querySelector('button[onclick="createTopic()"]');
    const originalText = createBtn.innerHTML;
    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    createBtn.disabled = true;
    
    // Get current topics
    const response = await fetch(GET_TOPICS_URL);
    let topics = await response.json();
    
    if (!Array.isArray(topics)) {
      topics = [];
    }
    
    // Create new topic object
    const newTopic = {
      id: Date.now().toString(),
      title: title,
      description: body.substring(0, 100) + (body.length > 100 ? '...' : ''),
      user: "Anonymous",
      date: new Date().toLocaleString(),
      messages: [{
        id: Date.now().toString() + "-msg",
        user: "Anonymous",
        text: body,
        date: new Date().toLocaleString(),
        likes: 0,
        replies: []
      }]
    };
    
    // Add to topics array
    topics.push(newTopic);
    
    // Save to server
    const saveResponse = await fetch(SAVE_TOPICS_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(topics)
    });
    
    if (!saveResponse.ok) {
      throw new Error(`Save failed: ${saveResponse.status}`);
    }
    
    // Clear form
    titleInput.value = "";
    bodyInput.value = "";
    
    // Show success message
    alert("Topic created successfully!");
    
    // Reload topics list
    loadTopics();
    
    // Redirect to the new topic thread after 1 second
    setTimeout(() => {
      window.location.href = `chatcenter_thread?topic=${newTopic.id}`;
    }, 1000);
    
  } catch (error) {
    console.error("Failed to create topic:", error);
    alert("Error creating topic: " + error.message);
  } finally {
    // Restore button state
    const createBtn = document.querySelector('button[onclick="createTopic()"]');
    if (createBtn) {
      createBtn.innerHTML = originalText || '<i class="fas fa-paper-plane"></i> Create Topic';
      createBtn.disabled = false;
    }
  }
}

// 4. Delete topic function
async function deleteTopic(topicId) {
  if (!confirm("Are you sure you want to delete this topic and all its messages?")) {
    return;
  }
  
  try {
    const response = await fetch(GET_TOPICS_URL);
    let topics = await response.json();
    
    if (!Array.isArray(topics)) topics = [];
    
    // Remove the topic
    const initialLength = topics.length;
    topics = topics.filter(topic => topic.id !== topicId);
    
    if (topics.length === initialLength) {
      alert("Topic not found. It may have already been deleted.");
      return;
    }
    
    // Save back to server
    const saveResponse = await fetch(SAVE_TOPICS_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(topics)
    });
    
    if (saveResponse.ok) {
      alert("Topic deleted successfully!");
      loadTopics(); // Reload the list
    } else {
      throw new Error(`Delete failed: ${saveResponse.status}`);
    }
    
  } catch (error) {
    console.error("Failed to delete topic:", error);
    alert("Error deleting topic: " + error.message);
  }
}

// 5. Pagination helper
function goToPage(pageNumber) {
  const url = new URL(window.location);
  url.searchParams.set('page', pageNumber);
  window.location.href = url.toString();
}

// 6. Initialize when page loads
window.addEventListener('DOMContentLoaded', () => {
  console.log("Chat Center page initialized");
  
  // Focus on title input
  const titleInput = document.getElementById("topicTitle");
  if (titleInput) {
    titleInput.focus();
  }
  
  // Load topics
  loadTopics();
  
  // Add Enter key support for creating topic
  if (titleInput) {
    titleInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById("topicBody").focus();
      }
    });
  }
  
  const bodyInput = document.getElementById("topicBody");
  if (bodyInput) {
    bodyInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        createTopic();
      }
    });
  }
});

// 7. Make functions available globally
window.loadTopics = loadTopics;
window.renderTopics = renderTopics;
window.createTopic = createTopic;
window.deleteTopic = deleteTopic;
window.goToPage = goToPage;
</script>

</body>
</html>
