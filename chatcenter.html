<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Center | RaceAnalyst</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Source+Serif+Pro:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            background: #f7f8fa;
            font-family: 'Source Serif Pro', serif;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
        }

        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.7rem;
            font-weight: 600;
        }

        .card {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.8rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            color: #1a3c34;
            margin-bottom: 1rem;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 0.6rem;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e6e6e6;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: 'Source Serif Pro';
        }

        button {
            background: #1a3c34;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            color: white;
            font-family: 'Montserrat';
            font-weight: 600;
            cursor: pointer;
        }

        button:hover {
            background: #244e44;
        }

        .topic-item {
            background: #f1f3f5;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .topic-item:hover {
            background: #e6eaed;
        }

        .topic-title {
            font-family: 'Montserrat';
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .topic-meta {
            font-size: 0.9rem;
            color: #666;
        }

        /* Thread view */
        .thread-message {
            background: #eef2f3;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            position: relative;
        }

        .reply-box {
            margin-top: 1rem;
            padding-left: 15px;
        }

        .reply-thread {
            margin-left: 20px;
            margin-top: 10px;
            border-left: 2px solid #d4af37;
            padding-left: 12px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            margin-right: 12px;
            font-size: 0.9rem;
        }

        .action-btn.delete {
            color: #d11a2a;
        }

        .action-btn.delete:hover {
            color: #ff0000;
            text-decoration: underline;
        }

        .pagination {
            text-align: center;
            margin-top: 1.2rem;
        }

        .pagination button {
            margin: 0 4px;
        }

        .logo-icon {
            font-size: 2rem;
            color: #d4af37;
        }
        
        /* Footer */
        footer {
            background-color: #1a3c34;
            color: white;
            padding: 3rem 0 1.5rem;
            margin-top: 3rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .footer-section h4 {
            color: #d4af37;
            margin-bottom: 1.2rem;
            font-size: 1.2rem;
        }
        
        .footer-section p {
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-links a {
            color: white;
            background-color: #2d5248;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .social-links a:hover {
            background-color: #d4af37;
            transform: translateY(-3px);
        }
        
        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid #2d5248;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* ===== HEADER STYLES ===== */
        header {
            background-color: #1a3c34;
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 2rem;
            color: #d4af37;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            color: white;
            font-weight: 700;
        }
        
        .logo span {
            color: #d4af37;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
            align-items: center;
            margin: 0;
            padding: 0;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        nav a:hover {
            color: #d4af37;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Mobile menu styles */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block !important;
            }
            
            .nav-menu ul {
                display: none;
                flex-direction: column;
                width: 100%;
                text-align: center;
                background: #1a3c34;
                position: absolute;
                top: 100%;
                left: 0;
                padding: 1rem 0;
                z-index: 1000;
                margin: 0;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }
            
            .nav-menu.active ul {
                display: flex !important;
            }
            
            .nav-menu ul li {
                padding: 0.8rem 0;
                width: 100%;
            }
            
            .nav-menu ul li a {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 0.5rem 0;
                width: 100%;
            }
            
            .header-content {
                position: relative;
            }
        }

        .topic-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: #f0f7f4 !important;
        }

        .topic-item button:hover {
            opacity: 0.9;
        }

        #chatOverlay {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .view-icon:hover {
            transform: scale(1.2);
        }
        .topic-row:hover {
            transform: scale(1.01);
            background:#fff;
        }

        /* Admin Panel Styles */
        .admin-panel {
            background: #fff8e1;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .admin-panel.active {
            display: block;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .admin-title {
            font-size: 1.1rem;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-login-btn {
            background: #d4af37 !important;
            color: #1a3c34 !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.9rem !important;
        }
        
        .admin-login-btn:hover {
            background: #e6c244 !important;
        }
        
        .admin-logged-in {
            background: #28a745 !important;
            color: white !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.9rem !important;
            cursor: default !important;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 6px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Admin Delete Button */
        .admin-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545 !important;
            color: white !important;
            border: none;
            padding: 4px 8px !important;
            border-radius: 4px;
            font-size: 0.8rem !important;
            cursor: pointer;
            z-index: 10;
        }

        .admin-delete-btn:hover {
            background: #c82333 !important;
        }

        .message-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            color: #dc3545;
            border: none;
            padding: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .message-delete-btn:hover {
            color: #ff0000;
            text-decoration: underline;
        }

    </style>
</head>

<body>
<header>
    <div class="container header-content">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-horse-head"></i>
            </div>
            <h1>Race<span>Analyst</span></h1>
        </div>

        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>

        <nav class="nav-menu" id="navMenu">
            <ul>
                <li><a href="#" onclick="navigateToHome()"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" onclick="navigateToRaceCalendar()"><i class="fas fa-calendar-alt"></i> Race Calendar</a></li>
                <li><a href="https://raceanalyst.pages.dev/chatcenter"><i class="fas fa-comments"></i> Chat Center</a></li>
                <li><a href="#" onclick="navigateToAnalysis()"><i class="fas fa-chart-bar"></i> Analysis</a></li>
                <li><a href="#" onclick="navigateToUpcomingRaces()"><i class="fas fa-flag-checkered"></i> Upcoming Races</a></li>
                <li id="adminNavItem" style="display: none;">
                    <a href="#" onclick="navigateToAdmin()" style="color: #d4af37; font-weight: 600;">
                        <i class="fas fa-user-shield"></i> Admin
                    </a>
                </li>
                <li id="logoutNavItem" style="display: none;">
                    <a href="#" id="logoutBtn" style="color: #ff6b6b;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <!-- Admin Panel (Shown only when authenticated) -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <div class="admin-title">
                <i class="fas fa-user-shield"></i> Admin Mode Active
            </div>
            <button class="btn-secondary" onclick="hideAdminPanel()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                <i class="fas fa-times"></i> Hide
            </button>
        </div>
        <div style="font-size: 0.9rem; color: #856404;">
            You can delete topics and messages. Admin status: <span id="adminStatus">Active</span>
        </div>
    </div>

    <!-- Create New Chat Topic -->
    <div class="card">
        <h2 id="newTopicHeader" style="cursor:pointer; display:flex; align-items:center; gap:12px; font-family:'Montserrat'; font-weight:700; font-size:1.35rem; color:#0f2e25; letter-spacing:0.5px;">
            <span id="newTopicToggleIcon" style="font-size:1.4rem; color:#d4af37;">‚ûï</span>
            <span style="background:linear-gradient(90deg,#1a3c34,#4d6f61); -webkit-background-clip:text; background-clip:text; color:transparent;">New Chat Topic</span>
        </h2>

        <div id="newTopicContent" style="display:none;">
            <input type="text" id="userNameInput" placeholder="Your Name" style="margin-bottom:1rem; padding:12px; border:2px solid #e6e6e6; border-radius:6px;">
            <input type="text" id="topicTitle" placeholder="Topic Title">
            <textarea id="topicBody" placeholder="Write the first message..." style="min-height:120px;"></textarea>
            <button onclick="createTopic()">
                <i class="fas fa-paper-plane"></i> Create Topic
            </button>
        </div>
    </div>

    <!-- Topics List with Expandable Chats -->
    <div class="card" id="topicsCard">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="font-family:'Montserrat'; font-weight:700; font-size:1.35rem; color:#0f2e25; letter-spacing:0.5px; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-comments" style="color:#d4af37;"></i>
                <span style="background:linear-gradient(90deg,#1a3c34,#4d6f61); -webkit-background-clip:text; background-clip:text; color:transparent;">All Chat Topics</span>
            </h2>
            
            <!-- Admin Status Indicator -->
            <div id="adminStatusIndicator" class="admin-logged-in" style="display: none;">
                <i class="fas fa-user-check"></i> <span id="adminUserName">Admin</span>
            </div>
        </div>
        
        <div id="topicsList">Loading topics...</div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Hidden Chat Thread Container (for expanded chats) -->
<div id="chatOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
    <div id="chatContainer" style="background:white; width:90%; max-width:800px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column;">
        <!-- Chat Header -->
        <div style="background:linear-gradient(135deg, #1a3c34 0%, #244e44 100%); color:white; padding:1.2rem; border-radius:12px 12px 0 0;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div style="flex:1;">
                    <div id="chatTopicTitle">
                        <!-- Topic details will be inserted here -->
                    </div>
                </div>
                <button onclick="closeChatThread()" 
                style="background:rgba(255,255,255,0.2); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1.2rem; transition:background 0.3s;">
                <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chatMessages" style="flex:1; overflow-y:auto; padding:1.5rem;">
            <div id="messagesContainer"></div>
        </div>
        
        <!-- Reply Input -->
        <div style="padding:1rem; border-top:1px solid #eee;">
            <input type="text" id="replyUserNameInput" placeholder="Your Name" style="margin-bottom:1rem; padding:12px; border:2px solid #e6e6e6; border-radius:6px;">
            <textarea id="chatReplyInput" placeholder="Write your reply..." style="width:100%; padding:0.8rem; border:2px solid #e6e6e6; border-radius:6px; min-height:80px; margin-bottom:0.8rem;"></textarea>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="submitChatReply()" style="background:#1a3c34; color:white; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer;">
                    <i class="fas fa-paper-plane"></i> Post Reply
                </button>
                <button onclick="closeChatThread()" style="background:#666; color:white; border:none; padding:0.6rem 1.2rem; border-radius:6px; cursor:pointer;">
                    Close Chat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<script>
// Configuration
const BASE_URL = "https://broad-sound-fdb7.raceanalyst.workers.dev";
const GET_TOPICS_URL = `${BASE_URL}/chatcenter/get-topics`;
const SAVE_TOPICS_URL = `${BASE_URL}/chatcenter/save-topics`;

// State management
let allTopics = [];
let currentOpenTopic = null;
let isAdminAuthenticated = false;
let currentAdminUser = null;

// ===== SIMPLE LOCALSTORAGE-BASED ADMIN DETECTION =====
function checkLocalStorageAuth() {
    console.log("üîê Checking localStorage for admin flag...");
    
    const adminFlag = localStorage.getItem('raceanalyst_admin');
    const adminUserStr = localStorage.getItem('raceanalyst_admin_user');
    
    if (adminFlag === 'true' && adminUserStr) {
        try {
            const adminUser = JSON.parse(adminUserStr);
            // Optional: add expiry (e.g., 7 days) for basic safety
            if (adminUser.timestamp && (Date.now() - adminUser.timestamp < 7 * 24 * 60 * 60 * 1000)) {
                isAdminAuthenticated = true;
                currentAdminUser = {
                    name: adminUser.name || adminUser.email?.split('@')[0] || 'Admin',
                    email: adminUser.email || 'admin@raceanalyst.in'
                };
                console.log("‚úÖ Admin access granted via localStorage");
                return { authenticated: true, user: currentAdminUser };
            } else {
                console.log("‚è∞ Admin session expired");
                clearAdminFlags();
            }
        } catch (e) {
            console.error("Corrupted admin data in localStorage", e);
            clearAdminFlags();
        }
    }
    
    isAdminAuthenticated = false;
    currentAdminUser = null;
    console.log("‚ùå No valid admin session");
    return { authenticated: false };
}

function clearAdminFlags() {
    localStorage.removeItem('raceanalyst_admin');
    localStorage.removeItem('raceanalyst_admin_user');
}

// Update UI based on localStorage auth status
function updateUIForAuthStatus(authResult) {
    const adminPanel = document.getElementById('adminPanel');
    const adminStatusIndicator = document.getElementById('adminStatusIndicator');
    const adminUserName = document.getElementById('adminUserName');
    const adminNavItem = document.getElementById('adminNavItem');
    const logoutNavItem = document.getElementById('logoutNavItem');
    
    if (authResult.authenticated) {
        // Show admin features
        if (adminPanel) adminPanel.classList.add('active');
        if (adminStatusIndicator) {
            adminStatusIndicator.style.display = 'flex';
            if (adminUserName) adminUserName.textContent = currentAdminUser.name;
        }
        if (adminNavItem) adminNavItem.style.display = 'block';
        if (logoutNavItem) logoutNavItem.style.display = 'block';
        
        showToast(`Admin mode active: ${currentAdminUser.name}`, 'success');
    } else {
        // Hide admin features
        if (adminPanel) adminPanel.classList.remove('active');
        if (adminStatusIndicator) adminStatusIndicator.style.display = 'none';
        if (adminNavItem) adminNavItem.style.display = 'none';
        if (logoutNavItem) logoutNavItem.style.display = 'none';
    }
    
    // Re-render topics to show/hide delete buttons
    loadTopics();
}

// Simple logout: just clear localStorage and reload
function logoutLocally() {
    if (confirm("Logout from admin mode?")) {
        clearAdminFlags();
        showToast('Logged out from admin mode', 'info');
        window.location.reload();
    }
}

// ===== HELPER FUNCTIONS =====
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.style.background = type === 'success' ? '#28a745' : 
                            type === 'error' ? '#dc3545' : 
                            type === 'info' ? '#17a2b8' : '#28a745';
    toast.style.display = "block";
    setTimeout(() => (toast.style.display = "none"), 3000);
}

function hideAdminPanel() {
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) {
        adminPanel.classList.remove('active');
        showToast('Admin panel hidden', 'info');
    }
}

// ===== NAVIGATION FUNCTIONS =====
function navigateToHome() {
    window.location.href = 'index.html#home';
    return false;
}

function navigateToRaceCalendar() {
    window.location.href = 'index.html#race-calendar';
    return false;
}

function navigateToAnalysis() {
    window.location.href = 'index.html#analysis';
    return false;
}

function navigateToUpcomingRaces() {
    window.location.href = 'index.html#upcoming-races';
    return false;
}

function navigateToAdmin() {
    window.location.href = 'admin.html';
    return false;
}

// ===== TOPIC & MESSAGE RENDERING =====
async function loadTopics() {
    try {
        const response = await fetch(GET_TOPICS_URL);
        if (!response.ok) throw new Error('Failed to load topics');
        allTopics = await response.json();
        
        renderTopicsList();
    } catch (error) {
        console.error(error);
        document.getElementById('topicsList').innerHTML = '<p style="color:red;">Failed to load topics.</p>';
    }
}

function renderTopicsList() {
    const container = document.getElementById('topicsList');
    if (allTopics.length === 0) {
        container.innerHTML = '<p>No topics yet. Create the first one!</p>';
        return;
    }

    const topicsHtml = allTopics.map(topic => {
        const totalMessages = (topic.messages?.length || 0) +
            (topic.messages?.reduce((sum, m) => sum + (m.replies?.length || 0), 0) || 0);

        return `
            <div class="topic-item" onclick="openChatThread('${topic.id}')">
                ${isAdminAuthenticated ? `
                    <button class="admin-delete-btn" onclick="event.stopPropagation(); deleteTopic('${topic.id}')">
                        <i class="fas fa-trash"></i> Delete Topic
                    </button>
                ` : ''}
                <div class="topic-title">${escapeHtml(topic.title || 'Untitled')}</div>
                <div class="topic-meta">
                    by ${escapeHtml(topic.user || 'Anonymous')} ‚Ä¢ ${formatDate(topic.date)} ‚Ä¢ ${totalMessages} message${totalMessages !== 1 ? 's' : ''}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = topicsHtml;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ===== CHAT THREAD FUNCTIONS =====
function openChatThread(topicId) {
    currentOpenTopic = allTopics.find(t => t.id === topicId);
    if (!currentOpenTopic) return;
    
    const overlay = document.getElementById('chatOverlay');
    const titleDiv = document.getElementById('chatTopicTitle');
    
    if (!overlay || !titleDiv) return;
    
    titleDiv.innerHTML = `
        <div style="font-size:1.3rem; font-weight:600; margin-bottom:0.5rem;">${escapeHtml(currentOpenTopic.title)}</div>
        <div style="font-size:0.9rem; opacity:0.9;">Created by ${escapeHtml(currentOpenTopic.user || 'Anonymous')} on ${formatDate(currentOpenTopic.date)}</div>
    `;
    
    renderChatMessages(currentOpenTopic.messages || []);
    overlay.style.display = 'flex';
    
    // Scroll to bottom of messages
    setTimeout(() => {
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
}

function closeChatThread() {
    document.getElementById('chatOverlay').style.display = 'none';
    currentOpenTopic = null;
    loadTopics(); // Refresh the topics list
}

function renderChatMessages(messages) {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    if (!messages || messages.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666; padding:2rem;">No messages yet. Be the first to reply!</p>';
        return;
    }
    
    const messagesHtml = messages.map(msg => `
        <div class="thread-message">
            <div style="display:flex; align-items:center; margin-bottom:8px;">
                <div style="width:32px; height:32px; border-radius:50%; margin-right:10px; background:#1a3c34; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                    ${(msg.user || 'A').charAt(0).toUpperCase()}
                </div>
                <div>
                    <strong>${escapeHtml(msg.user || 'Anonymous')}</strong>
                    <div style="font-size:0.8rem; color:#666;">${formatDate(msg.date)}</div>
                </div>
                ${isAdminAuthenticated ? 
                    `<button class="message-delete-btn" onclick="deleteChatMessage('${msg.id}')" title="Delete message">
                        <i class="fas fa-trash"></i>
                    </button>` : ''
                }
            </div>
            <div style="margin-left:42px;">${escapeHtml(msg.text || '')}</div>
            ${msg.replies && msg.replies.length > 0 ? `
                <div class="reply-thread">
                    ${renderReplies(msg.replies)}
                </div>
            ` : ''}
        </div>
    `).join('');
    
    container.innerHTML = messagesHtml;
}

function renderReplies(replies) {
    return replies.map(reply => `
        <div style="margin-bottom:12px; position:relative;">
            <div style="display:flex; align-items:center; margin-bottom:6px;">
                <div style="width:28px; height:28px; border-radius:50%; margin-right:8px; background:#244e44; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.8rem;">
                    ${(reply.user || 'A').charAt(0).toUpperCase()}
                </div>
                <div>
                    <strong style="font-size:0.9rem;">${escapeHtml(reply.user || 'Anonymous')}</strong>
                    <div style="font-size:0.75rem; color:#666;">${formatDate(reply.date)}</div>
                </div>
                ${isAdminAuthenticated ? 
                    `<button class="message-delete-btn" onclick="deleteChatMessage('${reply.id}')" title="Delete reply" style="top:5px; right:5px;">
                        <i class="fas fa-trash"></i>
                    </button>` : ''
                }
            </div>
            <div style="margin-left:36px; font-size:0.9rem;">${escapeHtml(reply.text || '')}</div>
        </div>
    `).join('');
}

// ===== DELETE FUNCTIONS =====
async function deleteTopic(topicId) {
    if (!isAdminAuthenticated) {
        showToast('Admin access required to delete topics', 'error');
        return;
    }

    const topic = allTopics.find(t => t.id === topicId);
    if (!topic) return;
    
    if (!confirm(`‚ö†Ô∏è Delete Topic?\n\n"${topic.title}"\n\nThis will delete all messages in this topic.\n\nThis action cannot be undone.\n\nProceed?`)) {
        return;
    }

    // Remove topic from array
    allTopics = allTopics.filter(t => t.id !== topicId);
    
    // Save to server
    await saveTopicsToServer();
    
    showToast('Topic deleted successfully', 'success');
    renderTopicsList();
    
    // Close chat if it was open
    if (currentOpenTopic && currentOpenTopic.id === topicId) {
        closeChatThread();
    }
}

async function deleteChatMessage(messageId) {
    if (!isAdminAuthenticated) {
        showToast('Admin access required to delete messages', 'error');
        return;
    }

    const topic = currentOpenTopic;
    if (!topic) return;
    
    // Find the message text for confirmation
    let messageText = "this message";
    function findMessage(messages) {
        for (let msg of messages) {
            if (msg.id === messageId) {
                messageText = msg.text.substring(0, 50) + (msg.text.length > 50 ? '...' : '');
                return true;
            }
            if (msg.replies && findMessage(msg.replies)) return true;
        }
        return false;
    }
    findMessage(topic.messages);

    if (!confirm("‚ö†Ô∏è Delete Message?\n\n\"" + messageText + "\"\n\nThis action cannot be undone.\n\nProceed?")) {
        return;
    }

    function removeMessage(messages, messageId) {
        return messages.filter(msg => {
            if (msg.id === messageId) return false;
            if (msg.replies) msg.replies = removeMessage(msg.replies, messageId);
            return true;
        });
    }

    topic.messages = removeMessage(topic.messages, messageId);

    const topicIndex = allTopics.findIndex(t => t.id === topic.id);
    if (topicIndex !== -1) allTopics[topicIndex] = topic;

    await saveTopicsToServer();
    renderChatMessages(topic.messages);
    showToast('Message deleted', 'success');
}

// ===== TOPIC CREATION =====
async function createTopic() {
    const userName = document.getElementById('userNameInput').value.trim();
    const title = document.getElementById('topicTitle').value.trim();
    const body = document.getElementById('topicBody').value.trim();
    
    if (!title || !body) {
        showToast('Please fill in both title and message', 'error');
        return;
    }
    
    const newTopic = {
        id: 'topic_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        title: title,
        user: userName || 'Anonymous',
        date: new Date().toISOString(),
        messages: [{
            id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            user: userName || 'Anonymous',
            text: body,
            date: new Date().toISOString(),
            replies: []
        }]
    };
    
    allTopics.unshift(newTopic);
    await saveTopicsToServer();
    
    // Clear form
    document.getElementById('userNameInput').value = '';
    document.getElementById('topicTitle').value = '';
    document.getElementById('topicBody').value = '';
    
    showToast('Topic created successfully!', 'success');
    renderTopicsList();
    closeNewTopicForm();
}

// ===== REPLY SUBMISSION =====
async function submitChatReply() {
    if (!currentOpenTopic) return;
    
    const userName = document.getElementById('replyUserNameInput').value.trim();
    const text = document.getElementById('chatReplyInput').value.trim();
    
    if (!text) {
        showToast('Please write a message', 'error');
        return;
    }
    
    const newMessage = {
        id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        user: userName || 'Anonymous',
        text: text,
        date: new Date().toISOString(),
        replies: []
    };
    
    currentOpenTopic.messages.push(newMessage);
    
    // Update in allTopics array
    const topicIndex = allTopics.findIndex(t => t.id === currentOpenTopic.id);
    if (topicIndex !== -1) allTopics[topicIndex] = currentOpenTopic;
    
    await saveTopicsToServer();
    
    // Clear form
    document.getElementById('chatReplyInput').value = '';
    document.getElementById('replyUserNameInput').value = '';
    
    showToast('Reply posted!', 'success');
    renderChatMessages(currentOpenTopic.messages);
    
    // Scroll to bottom
    setTimeout(() => {
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
}

// ===== SAVE TOPICS TO SERVER =====
async function saveTopicsToServer() {
    try {
        const response = await fetch(SAVE_TOPICS_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(allTopics)
        });
        
        if (!response.ok) throw new Error('Failed to save topics');
        return true;
    } catch (error) {
        console.error('Save error:', error);
        showToast('Failed to save. Please try again.', 'error');
        return false;
    }
}

// ===== NEW TOPIC FORM TOGGLE =====
function toggleNewTopicForm() {
    const content = document.getElementById('newTopicContent');
    const icon = document.getElementById('newTopicToggleIcon');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        icon.textContent = '‚ûñ';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ûï';
    }
}

function closeNewTopicForm() {
    document.getElementById('newTopicContent').style.display = 'none';
    document.getElementById('newTopicToggleIcon').textContent = '‚ûï';
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', async function() {
    // Check auth status
    const authResult = checkLocalStorageAuth();
    updateUIForAuthStatus(authResult);
    
    // Setup logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logoutLocally);
    }
    
    // Setup new topic toggle
    const newTopicHeader = document.getElementById('newTopicHeader');
    if (newTopicHeader) {
        newTopicHeader.addEventListener('click', toggleNewTopicForm);
    }
    
    // Load topics
    await loadTopics();
    
    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const navMenu = document.getElementById('navMenu');
    
    if (mobileMenuBtn && navMenu) {
        mobileMenuBtn.addEventListener('click', function() {
            navMenu.classList.toggle('active');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!mobileMenuBtn.contains(event.target) && !navMenu.contains(event.target)) {
                navMenu.classList.remove('active');
            }
        });
    }
});
</script>
</body>
</html>
